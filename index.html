<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Live DVR – Desktop & Mobile</title>
  <style>
    /* ---------- GENERAL ---------- */
    html, body {
      margin: 0;
      padding: 0;
      height: 100vh;
      font-family: Arial, sans-serif;
      background: #222;
      color: #fff;
      overflow: hidden;
    }
    .container {
      display: flex;
      height: 100vh;
    }

    /* ---------- SIDEBAR ---------- */
    #sidebar {
      background: #444;
      width: 220px;
      padding: 20px;
      box-sizing: border-box;
      overflow-y: auto;
      transition: transform .3s ease;
    }
    #sidebar.hidden {
      transform: translateX(-100%);
    }
    #btn-add-urls,
    .sideBtn,
    #urlModal button {
      width: 100%;
      padding: 10px;
      margin-bottom: 10px;
      font-size: 16px;
      cursor: pointer;
    }
    #sideButtons {
      display: flex;
      gap: 10px;
    }
    .sideBtn {
      flex: 1;
    }
    #streamList {
      margin-top: 10px;
      line-height: 1.2;
    }
    .no-streams {
      font-style: italic;
      color: #bbb;
    }
    .stream-item {
      display: flex;
      align-items: center;
      margin-bottom: 5px;
    }
    .stream-item label {
      margin-left: 5px;
      cursor: pointer;
      user-select: none;
    }

    /* ---------- MAIN CONTENT ---------- */
    #main-content {
      flex: 1;
      background: #333;
      padding: 20px;
      box-sizing: border-box;
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      overflow: auto;
    }
    html.mobile #main-content {
      flex-direction: column;
      align-items: center;
      flex-wrap: nowrap;
      margin-left: 0;
    }

    /* ---------- PLAYER CONTAINERS ---------- */
    .player-container {
      background: #222;
      display: flex;
      flex-direction: column;
      position: relative;
      box-sizing: border-box;
    }
    .player-container.desktop {
      width: 960px;
      height: 600px;
      margin-bottom: 40px;
    }
    .player-container.mobile {
      width: 240px;
      margin: 0 auto 20px;
      display: flex;
      flex-direction: column;
      background: #222;
      box-sizing: border-box;
    }

    /* --------- VIDEO & CANVAS --------- */
    .canvas-wrapper {
      position: relative;
      width: 960px;
      height: 540px;
      overflow: hidden;
    }
    .canvas-wrapper canvas {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
    }
    .player-container:fullscreen .canvas-wrapper,
    .player-container:-webkit-full-screen .canvas-wrapper {
      width: 100%!important;
      height: 100%!important;
    }
    .player-container:fullscreen .canvas-wrapper canvas,
    .player-container:-webkit-full-screen .canvas-wrapper canvas {
      width: 100%!important;
      height: 100%!important;
    }
    .player-container.desktop .source-video {
      opacity: 0;
      position: absolute;
      top: 0;
      left: 0;
      width: 960px;
      height: 540px;
      pointer-events: none;
    }
    .player-container.mobile .source-video {
      width: 240px;
      height: 135px;
    }
    .player-container.mobile .display-canvas {
      display: none;
    }

    /* ------ CONTROLS & OVERLAYS ------ */
    .controls-container {
      position: relative;
      z-index: 2;
    }
    .control-bar {
      display: flex;
      align-items: center;
      gap: 10px;
      background: rgba(0,0,0,0.75);
      padding: 5px 10px;
    }
    .control-bar button {
      padding: 4px 8px;
      cursor: pointer;
    }

    /* Custom progress bar */
    .progress-bar {
      position: relative;
      flex: 1 1 0;
      height: 6px;
      background: #fff;
      border-radius: 6px;
      overflow: visible;
      margin: 0 5px;
      cursor: pointer;
    }
    .progress-bar .buffered,
    .progress-bar .played {
      position: absolute;
      top: 0;
      bottom: 0;
      left: 0;
      border-radius: 6px;
    }
    .progress-bar .buffered {
      background: #888;
      width: 0%;
    }
    .progress-bar .played {
      background: #4d90fe;
      width: 0%;
    }
    .progress-bar .thumb {
      position: absolute;
      top: 50%;
      left: 0;
      width: 12px;
      height: 12px;
      background: #fff;
      border-radius: 50%;
      transform: translate(-50%,-50%);
      cursor: pointer;
    }

    .disable-btn {
      background: red;
      color: #fff;
      border: none;
    }
    .title-bar {
      text-align: center;
      background: rgba(0,0,0,0.75);
      padding: 2px 10px;
      font-size: 16px;
    }
    .overlay-controls {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
    }

    /* ------- URL MODAL & BACKDROP ------- */
    #modalBackdrop {
      display: none;
      position: fixed;
      z-index: 5;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
    }
    #urlModal {
      display: none;
      position: fixed;
      z-index: 10;
      left: 50%;
      top: 50%;
      transform: translate(-50%,-50%);
      width: 1200px;
      background: #555;
      border: 2px solid #fff;
      padding: 15px;
      box-sizing: border-box;
    }
    #urlModal textarea {
      width: 100%;
      height: 600px;
      padding: 10px;
      font-size: 14px;
      box-sizing: border-box;
    }

    /* ----- MOBILE SIDEBAR ----- */
    html.mobile #urlModal {
      width: 300px;
      padding: 4px;
      font-size: 12px;
    }
    html.mobile #urlModal textarea {
      height: 150px;
      padding: 5px;
      font-size: 12px;
    }
    html.mobile #sidebar {
      position: fixed;
      top: 0;
      left: 0;
      height: 100%;
      z-index: 1000;
    }
    #sidebarToggle {
      display: none;
    }
    html.mobile #sidebarToggle {
      display: block;
      position: fixed;
      top: 50%;
      left: 0;
      transform: translate(-50%,-50%);
      z-index: 1100;
      background: #444;
      border: none;
      padding: 10px 12px;
      font-size: 24px;
      color: #fff;
      cursor: pointer;
    }

    /* ----- MOBILE ROOT SCROLL OVERRIDE ----- */
    html.mobile {
      height: auto !important;
      overflow-y: auto !important;
      -webkit-overflow-scrolling: touch;
    }
    html.mobile body {
      height: auto !important;
      overflow: visible !important;
    }
    html.mobile .container {
      height: auto !important;
      min-height: 100vh;
    }
    html.mobile #main-content {
      height: auto !important;
      overflow: visible !important;
    }

    /* ------ MOBILE NON‑PSEUDO FULLSCREEN ------ */
    html.mobile .player-container.mobile:not(.fullscreen-mobile) {
      width: 100vw !important;
      height: auto !important;
      margin: 0 auto 20px !important;
    }
    html.mobile .player-container.mobile:not(.fullscreen-mobile) .source-video {
      width: 100% !important;
      height: auto !important;
      display: block;
    }
    html.mobile .player-container.mobile:not(.fullscreen-mobile) .controls-container,
    html.mobile .player-container.mobile:not(.fullscreen-mobile) .canvas-wrapper,
    html.mobile .player-container.mobile:not(.fullscreen-mobile) .display-canvas {
      display: none !important;
    }
    .video-title-row {
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 10px;
    }
    .fs-btn-mobile {
      margin-left: 10px;
      cursor: pointer;
      background: rgba(0,0,0,0.75);
      color: #fff;
      border: none;
      padding: 4px 8px;
      font-size: 16px;
    }

    /* ---------- MOBILE PSEUDO‑FULLSCREEN ---------- */
    html.mobile.pseudo-fullscreen {
      overflow-y: auto !important;
      height: 110vh !important;
      -webkit-overflow-scrolling: touch;
    }
    html.mobile.pseudo-fullscreen body {
      overflow: visible !important;
      height: auto !important;
    }
    html.mobile.pseudo-fullscreen .container {
      height: auto !important;
      min-height: 110vh !important;
    }
    html.mobile.pseudo-fullscreen #main-content {
      overflow: visible !important;
      height: auto !important;
    }
    html.mobile.pseudo-fullscreen #sidebarToggle {
      display: none;
    }
    html.mobile.pseudo-fullscreen .player-container.mobile.fullscreen-mobile {
      position: absolute;
      top: 0;
      left: 0;
      width: 100vw;
      height: 110vh;
      z-index: 1000;
      background: #000;
      overflow: hidden;
    }
    html.mobile.pseudo-fullscreen .player-container.mobile.fullscreen-mobile .source-video {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      object-fit: contain;
    }
    html.mobile.pseudo-fullscreen .player-container.mobile.fullscreen-mobile .controls-container {
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      z-index: 2;
      bottom: -100px;
      transition: bottom 0.3s ease;
    }
    html.mobile.pseudo-fullscreen .player-container.mobile.fullscreen-mobile.controls-open .controls-container {
      bottom: 20px;
    }
  </style>

  <script>
    // Mobile detection
    if (/Mobi|Android|iPhone|iPad/i.test(navigator.userAgent)) {
      document.documentElement.classList.add("mobile");
    }
    // Spacebar handling
    let spaceHeld = false;
    window.addEventListener("keydown", e => {
      if (e.code === "Space" &&
          !["input","textarea","button"].includes(document.activeElement.tagName.toLowerCase())) {
        e.preventDefault();
        spaceHeld = true;
      }
    });
    window.addEventListener("keyup", e => {
      if (e.code === "Space") spaceHeld = false;
    });
    // Cursor hide in fullscreen
    let cursorTimeout;
    function showCursor() { document.body.style.cursor = ""; }
    function hideCursor() { document.body.style.cursor = "none"; }
    document.addEventListener("fullscreenchange", () => {
      if (document.fullscreenElement) {
        showCursor();
        clearTimeout(cursorTimeout);
        cursorTimeout = setTimeout(hideCursor, 2000);
      } else {
        showCursor();
        clearTimeout(cursorTimeout);
      }
    });
    document.addEventListener("mousemove", () => {
      if (document.fullscreenElement) {
        showCursor();
        clearTimeout(cursorTimeout);
        cursorTimeout = setTimeout(hideCursor, 2000);
      }
    });

    // Helper to hide browser UI on mobile
    function hideBrowserUI() {
      document.documentElement.style.height = '110vh';
      document.body.style.height = '110vh';
      window.scrollTo(0,1);
      Promise.resolve().then(() => window.scrollTo(0,1));
    }
  </script>
</head>
<body>
  <button id="sidebarToggle">&#x25B6;</button>
  <div class="container">
    <div id="sidebar">
      <button id="btn-add-urls">Add URLs</button>
      <div id="sideButtons">
        <button id="btn-show-all" class="sideBtn">Show All</button>
        <button id="btn-hide-all" class="sideBtn">Hide All</button>
      </div>
      <div id="streamList"></div>
    </div>
    <div id="main-content"></div>
  </div>
  <div id="modalBackdrop"></div>
  <div id="urlModal">
    <h3 style="margin-top:0; text-align:center;">Paste Playlist URLs (one per line)</h3>
    <textarea id="urlInput" placeholder="https://…/playlist.m3u8"></textarea>
    <button id="saveUrls">Save and Close</button>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/hls.js@0.14.16"></script>
  <script>
    function enterFullScreen(el) {
      const r = el.requestFullscreen
             || el.webkitRequestFullscreen
             || el.mozRequestFullScreen
             || el.msRequestFullscreen;
      if (r) return r.call(el);
    }
    function exitFullScreen() {
      const e = document.exitFullscreen
             || document.webkitExitFullscreen
             || document.mozCancelFullScreen
             || document.msExitFullscreen;
      if (e) return e.call(document);
    }

    const PROXY_PREFIX = "https://surfcam-alpha.vercel.app/api/proxy?url=";
    function loadPlayerSettings(u) {
      try { return JSON.parse(localStorage.playerSettings||"{}")[u] || {zoomScale:1,panX:0,panY:0}; }
      catch { return {zoomScale:1,panX:0,panY:0}; }
    }
    function savePlayerSettings(u,d) {
      let o = {};
      try { o = JSON.parse(localStorage.playerSettings||"{}"); } catch {}
      o[u] = d;
      localStorage.playerSettings = JSON.stringify(o);
    }
    function clampPan(c) {
      const Z = c.zoomScale, W = 960, H = 540;
      if (Z <= 1) { c.panX = 0; c.panY = 0; return; }
      const mx = (W*(Z-1))/(2*Z), my = (H*(Z-1))/(2*Z);
      c.panX = Math.min(mx, Math.max(-mx, c.panX));
      c.panY = Math.min(my, Math.max(-my, c.panY));
    }

    (function(){
      const storageKey = "streamConfigs", activeLabels = new Set();
      function getStreamList(){
        try { return JSON.parse(localStorage[storageKey]||"[]"); }
        catch { return []; }
      }
      function saveStreamList(l){
        localStorage[storageKey] = JSON.stringify(l);
      }
      function extractTitle(u){
        const m = u.match(/wc-([^\/]+)\/playlist/);
        return m ? m[1] : u;
      }

      function updateStreamSidebar(){
        const sb = document.getElementById("streamList");
        sb.innerHTML = "";
        const streams = getStreamList();
        if (!streams.length) {
          const p = document.createElement("p");
          p.className = "no-streams";
          p.textContent = "No streams added. Click 'Add URLs'.";
          sb.appendChild(p);
        } else {
          streams.forEach(s => {
            const item = document.createElement("div");
            item.className = "stream-item";
            const cb = document.createElement("input");
            cb.type = "checkbox";
            cb.checked = s.enabled;
            cb.dataset.url = s.url;
            cb.addEventListener("change", e => updateStreamEnabled(s.url, e.target.checked));
            item.appendChild(cb);
            const lbl = document.createElement("label");
            lbl.textContent = extractTitle(s.url);
            lbl.dataset.url = s.url;
            lbl.addEventListener("mousedown", e => {
              if (e.button === 0) { cb.checked = !cb.checked; activeLabels.add(lbl); e.preventDefault(); }
            });
            lbl.addEventListener("mouseenter", e => {
              if (e.buttons & 1 && !activeLabels.has(lbl)) {
                cb.checked = !cb.checked;
                activeLabels.add(lbl);
              }
            });
            item.appendChild(lbl);
            sb.appendChild(item);
          });
        }
      }
      document.addEventListener("mouseup", () => {
        activeLabels.forEach(lbl => {
          const url = lbl.dataset.url,
                cb  = lbl.parentNode.querySelector("input");
          updateStreamEnabled(url, cb.checked);
        });
        activeLabels.clear();
      });

      function reorderPlayers(){
        const main = document.getElementById("main-content"),
              cfg  = getStreamList();
        Array.from(main.children)
          .sort((a,b) => cfg.findIndex(x=>x.url===a.dataset.url)
                          - cfg.findIndex(x=>x.url===b.dataset.url))
          .forEach(el => main.appendChild(el));
      }

      function updateStreamEnabled(url, enabled){
        let streams = getStreamList(),
            idx     = streams.findIndex(s=>s.url===url);
        if (idx === -1) return;
        streams[idx].enabled = enabled;
        saveStreamList(streams);
        const main = document.getElementById("main-content"),
              player = main.querySelector(`.player-container[data-url="${url}"]`);
        if (enabled) {
          if (!player) {
            const pc = createPlayerContainer(streams[idx]);
            if (pc) main.appendChild(pc);
          } else {
            player.style.display = "flex";
          }
        } else if (player) {
          if (player.hls) player.hls.destroy();
          player.remove();
        }
        reorderPlayers();
        updateStreamSidebar();
      }

      // Sets up controls/timeline and gestures in pseudo‑full screen mobile
      function setupPseudoMobileInteractions(container, video){
        const mc = document.createElement("div");
        mc.className = "controls-container";
        container.appendChild(mc);
        const bar = document.createElement("div");
        bar.className = "control-bar";
        mc.appendChild(bar);
        // play/pause button
        const playBtn = document.createElement("button");
        playBtn.textContent = "Play";
        bar.appendChild(playBtn);
        playBtn.addEventListener("click", ()=>{
          if (video.paused) video.play().catch(()=>{});
          else video.pause();
        });
        video.addEventListener("play", ()=> playBtn.textContent = "Pause");
        video.addEventListener("pause", ()=> playBtn.textContent = "Play");
        // scrub bar
        const scrub = document.createElement("input");
        scrub.type = "range";
        scrub.min = 0;
        scrub.step = 0.1;
        scrub.value = 0;
        bar.appendChild(scrub);
        let seeking = false;
        scrub.addEventListener("mousedown", ()=> seeking = true);
        scrub.addEventListener("mouseup",   ()=> seeking = false);
        scrub.addEventListener("input",     ()=> video.currentTime = parseFloat(scrub.value));
        video.addEventListener("loadedmetadata", ()=>{
          scrub.max = video.duration || 0;
          scrub.value = video.currentTime;
        });
        video.addEventListener("timeupdate", ()=>{
          if (!seeking) scrub.value = video.currentTime;
        });
        // title bar
        const tbar = document.createElement("div");
        tbar.className = "title-bar";
        tbar.textContent = extractTitle(container.dataset.url);
        mc.appendChild(tbar);

        // touch gestures
        let startX, startY, startT, gesture = "";
        container.addEventListener("touchstart", e=>{
          if (e.touches.length === 1) {
            startX = e.touches[0].clientX;
            startY = e.touches[0].clientY;
            startT = Date.now();
            gesture = "";
          }
        }, { passive: true });
        container.addEventListener("touchmove", e=>{
          if (!container.classList.contains("fullscreen-mobile") || e.touches.length !== 1) return;
          const dx = e.touches[0].clientX - startX,
                dy = e.touches[0].clientY - startY;
          if (!gesture) {
            if (Math.hypot(dx,dy) < 10) return;
            gesture = Math.abs(dx) > Math.abs(dy) ? "h" : "v";
          }
          if (gesture === "h") {
            e.preventDefault();
            const frac = dx / container.clientWidth;
            video.currentTime += frac * video.duration;
            startX = e.touches[0].clientX;
          }
        }, { passive: false });
        container.addEventListener("touchend", e=>{
          if (!container.classList.contains("fullscreen-mobile") || e.touches.length > 0) return;
          const dt   = Date.now() - startT,
                endY = e.changedTouches[0].clientY;
          if (gesture === "v" && Math.abs(endY - startY) > 50 && dt < 500) {
            if (endY < startY) {
              container.classList.add("controls-open");
            } else {
              container.classList.remove("fullscreen-mobile");
              container.classList.remove("controls-open");
              document.documentElement.classList.remove("pseudo-fullscreen");
            }
          }
        });
      }

      // Creates a player container for desktop or mobile
      function createPlayerContainer(stream){
        if (!stream.enabled) return null;
        const url      = stream.url,
              isMobile = document.documentElement.classList.contains("mobile"),
              saved    = loadPlayerSettings(url);

        const container = document.createElement("div");
        container.className = "player-container " + (isMobile ? "mobile" : "desktop");
        container.dataset.url = url;
        container.zoomScale = saved.zoomScale;
        container.panX      = saved.panX;
        container.panY      = saved.panY;

        const video = document.createElement("video");
        video.className = "source-video";
        ["playsinline","webkit-playsinline","crossorigin"].forEach(a=>video.setAttribute(a,""));
        video.muted   = true;
        video.preload = "auto";
        if (isMobile) {
          video.controls = false;
          video.src      = PROXY_PREFIX + encodeURIComponent(url);
        } else {
          video.autoplay = true;
        }
        container.appendChild(video);

        if (isMobile) {
          // — Non‑pseudo fullscreen layout —
          const titleRow = document.createElement("div");
          titleRow.className = "video-title-row";
          const titleSpan = document.createElement("span");
          titleSpan.textContent = extractTitle(url);
          titleRow.appendChild(titleSpan);
          const fsBtn = document.createElement("button");
          fsBtn.className = "fs-btn-mobile";
          fsBtn.textContent = "⛶";
          titleRow.appendChild(fsBtn);
          container.appendChild(titleRow);

          // tap toggles play/pause
          video.addEventListener("click", ()=>{
            if (video.paused) video.play().catch(()=>{});
            else video.pause();
          });

          // fullscreen button
          fsBtn.addEventListener("click", ()=>{
            if (container.hls) container.hls.startLoad();
            container.classList.add("fullscreen-mobile");
            document.documentElement.classList.add("pseudo-fullscreen");
            hideBrowserUI();
            container.addEventListener("touchmove", hideBrowserUI, { passive: true, once: true });
            setupPseudoMobileInteractions(container, video);
            video.play().catch(()=>{});
          });

        } else {
          // ——— DESKTOP CODE UNCHANGED ———
          const wrapper = document.createElement("div");
          wrapper.className = "canvas-wrapper";
          container.appendChild(wrapper);

          const canvas = document.createElement("canvas");
          canvas.className = "display-canvas";
          canvas.width  = 960;
          canvas.height = 540;
          wrapper.appendChild(canvas);

          const ctx = canvas.getContext("2d");
          (function render(){
            if (video.readyState >= 2) {
              clampPan(container);
              ctx.save();
              ctx.clearRect(0,0,960,540);
              const cx = 480, cy = 270;
              ctx.translate(cx,cy);
              ctx.scale(container.zoomScale, container.zoomScale);
              ctx.translate(container.panX, container.panY);
              ctx.translate(-cx,-cy);
              try { ctx.drawImage(video,0,0,960,540); } catch {}
              ctx.restore();
            }
            requestAnimationFrame(render);
          })();

          let sx, sy, dragging = false;
          wrapper.addEventListener("mousedown", e => {
            if (e.button !== 0 || (!spaceHeld && document.fullscreenElement !== container)) return;
            sx = e.clientX; sy = e.clientY; dragging = false;
          });
          wrapper.addEventListener("mousemove", e => {
            if (!(e.buttons & 1) || (!spaceHeld && document.fullscreenElement !== container)) return;
            const dx = e.clientX - sx, dy = e.clientY - sy;
            if (!dragging && Math.hypot(dx,dy) > 5) dragging = true;
            if (dragging) {
              container.panX += dx / container.zoomScale;
              container.panY += dy / container.zoomScale;
              clampPan(container);
              savePlayerSettings(url, {
                zoomScale: container.zoomScale,
                panX: container.panX,
                panY: container.panY
              });
              sx = e.clientX; sy = e.clientY;
            }
          });
          wrapper.addEventListener("wheel", e => {
            if (!spaceHeld && document.fullscreenElement !== container) return;
            e.preventDefault();
            const rect = wrapper.getBoundingClientRect();
            const dx   = (e.clientX - rect.left) / rect.width  * 960;
            const dy   = (e.clientY - rect.top)  / rect.height * 540;
            const oldZ = container.zoomScale;
            let z = oldZ + (e.deltaY < 0 ? 0.1 : -0.1);
            z = Math.max(1, Math.min(3, z));
            container.panX += (dx - 480) * (1/z - 1/oldZ);
            container.panY += (dy - 270) * (1/z - 1/oldZ);
            container.zoomScale = z;
            clampPan(container);
            savePlayerSettings(url, {
              zoomScale: z,
              panX: container.panX,
              panY: container.panY
            });
          }, { passive: false });

          let ct = 0, cx = 0, cy = 0;
          wrapper.addEventListener("mousedown", e => {
            if (e.button !== 0) return;
            ct = Date.now(); cx = e.clientX; cy = e.clientY;
          });
          wrapper.addEventListener("mouseup", e => {
            const dt = Date.now() - ct;
            if (dt < 200 && Math.hypot(e.clientX - cx, e.clientY - cy) < 5) {
              if (video.paused) video.play().catch(()=>{}); else video.pause();
            }
          });

          // overlay controls
          const cc = document.createElement("div");
          cc.className = "controls-container overlay-controls";
          container.appendChild(cc);

          const bar = document.createElement("div");
          bar.className = "control-bar";
          cc.appendChild(bar);

          const playBtn = document.createElement("button");
          playBtn.textContent = "Play";
          playBtn.addEventListener("click", ()=>{
            if (video.paused) video.play().catch(()=>{});
            else video.pause();
          });
          video.addEventListener("play",  ()=> playBtn.textContent = "Pause");
          video.addEventListener("pause", ()=> playBtn.textContent = "Play");
          bar.appendChild(playBtn);

          const prog = document.createElement("div");
          prog.className = "progress-bar";
          const bufBar  = document.createElement("div"); bufBar.className = "buffered";
          const playBar = document.createElement("div"); playBar.className = "played";
          const thumb   = document.createElement("div"); thumb.className = "thumb";
          prog.appendChild(bufBar); prog.appendChild(playBar); prog.appendChild(thumb);
          bar.appendChild(prog);

          function updateProgress(){
            const d = video.duration||0;
            if (!d) return;
            const c = video.currentTime;
            const bufEnd = video.buffered.length ? video.buffered.end(video.buffered.length-1) : c;
            playBar.style.width = (c/d*100) + "%";
            bufBar.style.width  = (bufEnd/d*100) + "%";
            thumb.style.left    = (c/d*100) + "%";
          }
          ["loadedmetadata","timeupdate","progress"].forEach(evt=>
            video.addEventListener(evt, updateProgress)
          );

          let draggingThumb = false;
          thumb.addEventListener("mousedown", ()=> draggingThumb = true);
          document.addEventListener("mouseup",   ()=> draggingThumb = false);
          document.addEventListener("mousemove", e=>{
            if (!draggingThumb) return;
            const rect = prog.getBoundingClientRect();
            let pct = (e.clientX - rect.left) / rect.width;
            pct = Math.max(0, Math.min(1, pct));
            video.currentTime = pct * (video.duration||0);
          });
          prog.addEventListener("click", e=>{
            const rect = prog.getBoundingClientRect();
            let pct = (e.clientX - rect.left) / rect.width;
            pct = Math.max(0, Math.min(1, pct));
            video.currentTime = pct * (video.duration||0);
          });

          const fsBtn = document.createElement("button");
          fsBtn.textContent = "⛶";
          fsBtn.addEventListener("click", ()=>{
            if (!document.fullscreenElement) enterFullScreen(container);
            else exitFullScreen();
          });
          bar.appendChild(fsBtn);

          const resetBtn = document.createElement("button");
          resetBtn.textContent = "Reset";
          resetBtn.addEventListener("click", ()=>{
            container.zoomScale = 1;
            container.panX = 0;
            container.panY = 0;
            savePlayerSettings(url, {zoomScale:1,panX:0,panY:0});
          });
          bar.appendChild(resetBtn);

          const disableBtn = document.createElement("button");
          disableBtn.className = "disable-btn";
          disableBtn.textContent = "X";
          disableBtn.addEventListener("click", e=>{
            e.stopPropagation();
            updateStreamEnabled(url, false);
          });
          bar.appendChild(disableBtn);

          const titleBar = document.createElement("div");
          titleBar.className = "title-bar";
          titleBar.textContent = extractTitle(url);
          cc.appendChild(titleBar);

          let hideTO;
          function scheduleHide(){
            hideTO = setTimeout(()=> cc.style.opacity = 0, 3000);
          }
          document.addEventListener("fullscreenchange", ()=>{
            if (document.fullscreenElement === container){
              cc.style.opacity = 1;
              scheduleHide();
            } else {
              cc.style.opacity = 1;
              clearTimeout(hideTO);
            }
          });
          document.addEventListener("mousemove", e=>{
            if (document.fullscreenElement === container && e.clientY > window.innerHeight - 100){
              cc.style.opacity = 1;
              clearTimeout(hideTO);
              scheduleHide();
            }
          });
        }

        // —— HLS logic (unchanged) ——
        const canNative = video.canPlayType("application/vnd.apple.mpegurl");
        if (Hls.isSupported() && !canNative){
          const hls = new Hls({
            maxBufferLength:120,
            maxBufferSize:60*1024*1024,
            liveSyncDurationCount:3,
            manifestLoadingTimeOut:30000,
            levelLoadingTimeOut:30000,
            loader: class extends Hls.DefaultConfig.loader {
              load(ctx, cfg, cb){
                let u = ctx.url;
                while (u.startsWith(PROXY_PREFIX)) {
                  u = decodeURIComponent(u.slice(PROXY_PREFIX.length));
                }
                ctx.url = PROXY_PREFIX + encodeURIComponent(u);
                super.load(ctx, cfg, cb);
              }
            }
          });
          hls.attachMedia(video);
          hls.on(Hls.Events.MANIFEST_PARSED, ()=> video.play().catch(()=>{}));
          hls.loadSource(url);
          hls.on(Hls.Events.ERROR, (_, d)=>{
            if (d.fatal){
              switch(d.type){
                case Hls.ErrorTypes.NETWORK_ERROR: hls.startLoad(); break;
                case Hls.ErrorTypes.MEDIA_ERROR:   hls.recoverMediaError(); break;
                default:                            hls.destroy(); break;
              }
            }
          });
          container.hls = hls;
        } else if (canNative){
          video.src = PROXY_PREFIX + encodeURIComponent(url);
          if (!isMobile) video.play().catch(()=>{});
        }

        // dblclick for fullscreen (unchanged)
        container.addEventListener("dblclick", ()=>{
          if (!document.fullscreenElement) enterFullScreen(container);
          else exitFullScreen();
        });

        return container;
      }

      /* ——— SIDEBAR BUTTONS & MODAL HANDLERS ——— */
      document.getElementById("btn-show-all")
        .addEventListener("click", ()=> getStreamList().forEach(s=>updateStreamEnabled(s.url,true)));
      document.getElementById("btn-hide-all")
        .addEventListener("click", ()=> getStreamList().forEach(s=>updateStreamEnabled(s.url,false)));

      const modal     = document.getElementById("urlModal"),
            backdrop  = document.getElementById("modalBackdrop"),
            btnAdd    = document.getElementById("btn-add-urls"),
            btnSave   = document.getElementById("saveUrls"),
            urlInput  = document.getElementById("urlInput");

      btnAdd.addEventListener("click", ()=>{
        urlInput.value = getStreamList().map(s=>s.url).join("\n");
        modal.style.display   = backdrop.style.display = "block";
      });
      btnSave.addEventListener("click", ()=>{
        const lines  = urlInput.value.split("\n").map(u=>u.trim()).filter(Boolean),
              oldCfg = getStreamList(),
              newCfg = [];
        lines.forEach(u=>{
          const ex = oldCfg.find(s=>s.url===u);
          newCfg.push(ex ? ex : {url:u,enabled:true});
        });
        saveStreamList(newCfg);
        oldCfg.forEach(s=>{
          if (!lines.includes(s.url)) updateStreamEnabled(s.url,false);
        });
        newCfg.forEach(s=>{
          if (s.enabled) updateStreamEnabled(s.url,true);
        });
        updateStreamSidebar();
        modal.style.display   = backdrop.style.display = "none";
        urlInput.value = "";
      });
      backdrop.addEventListener("click", ()=>{
        modal.style.display   = backdrop.style.display = "none";
      });
      window.addEventListener("keydown", e=>{
        if (e.key === "Escape" && backdrop.style.display === "block") backdrop.click();
      });

      /* ——— MOBILE SIDEBAR SWIPE & TOGGLE ——— */
      if (document.documentElement.classList.contains("mobile")){
        const sidebar = document.getElementById("sidebar"),
              toggle  = document.getElementById("sidebarToggle"),
              main    = document.getElementById("main-content");
        let sx, ex;
        sidebar.addEventListener("touchstart", e=> sx = e.changedTouches[0].screenX );
        sidebar.addEventListener("touchend",   e=>{
          ex = e.changedTouches[0].screenX;
          if (sx - ex > 50) {
            sidebar.classList.add("hidden");
            toggle.style.display = "block";
          }
        });
        toggle.addEventListener("click", ()=>{
          sidebar.classList.remove("hidden");
          toggle.style.display = "none";
        });
        main.addEventListener("touchstart", ()=>{
          sidebar.classList.add("hidden");
          toggle.style.display = "block";
        });
      }

      /* ——— INITIALIZE ——— */
      updateStreamSidebar();
      getStreamList().forEach(s=>{
        if (s.enabled) updateStreamEnabled(s.url,true);
      });
    })();
  </script>
</body>
</html>