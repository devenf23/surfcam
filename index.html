<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>Live DVR – Desktop & Mobile</title>
  <style>
    /* ---------- GENERAL ---------- */
    html, body {
      margin: 0;
      padding: 0;
      height: 100vh;
      font-family: Arial, sans-serif;
      background: #222;
      color: #fff;
      overflow: hidden;
      position: fixed;
      width: 100%;
    }
    .container {
      display: flex;
      height: 100vh;
      width: 100%;
    }

    /* ---------- SIDEBAR ---------- */
    #sidebar {
      background: #444;
      width: 220px;
      padding: 20px;
      box-sizing: border-box;
      overflow-y: auto;
      transition: transform .3s ease;
      flex-shrink: 0;
      z-index: 1000;
      -webkit-overflow-scrolling: touch;
    }
    #sidebar.hidden {
      transform: translateX(-100%);
    }
    #btn-add-urls,
    .sideBtn,
    #urlModal button {
      width: 100%;
      padding: 10px;
      margin-bottom: 10px;
      font-size: 16px;
      cursor: pointer;
      border-radius: 8px;
      border: 1px solid #666;
      background-color: #555;
      color: #fff;
    }
    #btn-add-urls:hover,
    .sideBtn:hover,
    #urlModal button:hover {
      background-color: #666;
    }
    #sideButtons {
      display: flex;
      gap: 10px;
    }
    .sideBtn {
      flex: 1;
    }
    #streamList {
      margin-top: 10px;
      line-height: 1.2;
    }
    .no-streams {
      font-style: italic;
      color: #bbb;
    }
    .stream-item {
      display: flex;
      align-items: center;
      margin-bottom: 5px;
      padding: 5px;
      border-radius: 4px;
      transition: background-color 0.2s;
    }
    .stream-item.selecting {
      background-color: #666;
    }
    .stream-item:hover {
      background-color: #555;
    }
    .stream-item label {
      margin-left: 8px;
      cursor: pointer;
      user-select: none;
      flex-grow: 1;
    }
    .stream-item input[type="checkbox"] {
      cursor: pointer;
      width: 18px;
      height: 18px;
      flex-shrink: 0;
    }

    /* ---------- MAIN CONTENT ---------- */
    #main-content {
      flex: 1;
      background: #333;
      padding: 20px;
      box-sizing: border-box;
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      overflow: auto;
      border-radius: 8px 0 0 8px;
      height: 100vh;
      -webkit-overflow-scrolling: touch;
      align-content: flex-start;
    }
    html.mobile #main-content {
      flex-direction: column;
      align-items: center;
      flex-wrap: nowrap;
      margin-left: 0;
      border-radius: 0;
      padding-top: 60px;
      height: 100vh;
      overflow-y: scroll;
    }

    /* ---------- PLAYER CONTAINERS ---------- */
    .player-container {
      background: #222;
      display: flex;
      flex-direction: column;
      position: relative;
      box-sizing: border-box;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      flex-shrink: 0;
    }
    .player-container.desktop {
      width: 960px;
      max-width: 100%;
      margin-bottom: 20px;
    }
    .player-container.mobile {
      margin: 0 auto 20px;
      width: calc(100% - 40px);
      max-width: 480px;
      border-radius: 12px;
      overflow: hidden;
    }
    .player-container.mp4-player .source-video {
      border-radius: 12px 12px 0 0;
      display: block;
      width: 100%;
      height: auto;
      aspect-ratio: 16/9;
      background: #000;
    }
    .player-container.mp4-player .controls-container {
      background: none;
    }
    .player-container.mp4-player .title-bar {
      border-radius: 0 0 12px 12px;
      border-top: none;
    }

    /* --------- VIDEO & CANVAS --------- */
    .canvas-wrapper {
      position: relative;
      width: 100%;
      aspect-ratio: 16/9;
      overflow: hidden;
      border-radius: 12px 12px 0 0;
      background-color: #000;
    }
    .canvas-wrapper canvas {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: block;
    }

    /* Hide the raw <video> under the canvas on desktop HLS */
    .player-container.desktop:not(.mp4-player) .source-video {
      opacity: 0;
      position: absolute;
      top: -9999px;
      left: -9999px;
      width: 1px;
      height: 1px;
      pointer-events: none;
    }

    /* Native Fullscreen (Desktop) */
    .player-container:fullscreen,
    .player-container:-webkit-full-screen {
      width: 100%!important;
      height: 100%!important;
      max-width: none!important;
      border-radius: 0!important;
      box-shadow: none!important;
      z-index: 2147483647;
      background-color: #000;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      overflow: hidden;
    }
    .player-container:fullscreen .canvas-wrapper,
    .player-container:-webkit-full-screen .canvas-wrapper {
      width: 100%;
      height: 100%;
      border-radius: 0;
      position: relative;
      flex-grow: 1;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    .player-container:fullscreen .canvas-wrapper canvas,
    .player-container:-webkit-full-screen .canvas-wrapper canvas {
      width: 100%!important;
      height: 100%!important;
    }

    .player-container.mp4-player:fullscreen .source-video,
    .player-container.mp4-player:-webkit-full-screen .source-video {
      width: 100%!important;
      height: 100%!important;
      object-fit: cover;
      border-radius: 0;
      aspect-ratio: auto;
    }
    .player-container.mp4-player:fullscreen .controls-container,
    .player-container.mp4-player:-webkit-full-screen .controls-container {
      display: none!important;
    }

    /* ---------- CONTROLS & OVERLAYS ---------- */
    .controls-container {
      position: relative;
      z-index: 2;
      background: #222;
      border-radius: 0 0 12px 12px;
    }
    .control-bar {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 12px;
    }
    .control-bar button {
      padding: 6px 10px;
      cursor: pointer;
      background-color: #555;
      border: none;
      color: #fff;
      border-radius: 6px;
      font-size: 14px;
      transition: background-color 0.2s;
      flex-shrink: 0;
    }
    .control-bar button:hover { background-color: #666; }
    .progress-bar {
      position: relative;
      flex: 1 1 auto;
      height: 8px;
      background: #555;
      border-radius: 8px;
      overflow: visible;
      margin: 0 10px;
      cursor: pointer;
      min-width: 50px;
    }
    .progress-bar .buffered,
    .progress-bar .played {
      position: absolute;
      top: 0; bottom: 0; left: 0;
      border-radius: 8px;
      pointer-events: none;
    }
    .progress-bar .buffered { background: #888; width: 0%; opacity: 0.7; }
    .progress-bar .played   { background: #4d90fe; width: 0%; z-index: 1; }
    .progress-bar .thumb {
      position: absolute;
      top: 50%;
      left: 0;
      width: 14px;
      height: 14px;
      background: #fff;
      border-radius: 50%;
      transform: translate(-50%,-50%);
      cursor: pointer;
      z-index: 2;
      box-shadow: 0 0 5px rgba(0,0,0,0.5);
      transition: transform 0.1s ease;
    }
    .progress-bar:hover .thumb {
      transform: translate(-50%,-50%) scale(1.1);
    }

    .disable-btn { background: #e74c3c; color: #fff; border: none; }
    .disable-btn:hover { background: #c0392b; }

    .title-bar {
      text-align: center;
      padding: 5px 10px;
      font-size: 14px;
      color: #eee;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      background: rgba(0,0,0,0.75);
      border-radius: 0 0 12px 12px;
    }
    .control-bar + .title-bar {
      border-radius: 0;
      border-top: 1px solid #444;
    }

    /* Desktop Controls in Fullscreen */
    .player-container:not(.mp4-player):fullscreen .controls-container,
    .player-container:not(.mp4-player):-webkit-full-screen .controls-container {
      position: absolute;
      bottom: 10px;
      left: 50%;
      transform: translateX(-50%);
      opacity: 0;
      transition: opacity 0.3s ease;
      border-radius: 8px;
      background: rgba(0,0,0,0.75);
      pointer-events: none;
      width: 90%;
      max-width: 800px;
      margin: 0;
      flex-shrink: 0;
    }
    .player-container:not(.mp4-player):fullscreen:hover .controls-container,
    .player-container:not(.mp4-player):-webkit-full-screen:hover .controls-container {
      opacity: 1;
      pointer-events: auto;
    }
    .player-container:not(.mp4-player):fullscreen .title-bar,
    .player-container:not(.mp4-player):-webkit-full-screen .title-bar {
      border-radius: 0 0 8px 8px;
      border-top: 1px solid #444;
    }

    /* ------- URL MODAL & BACKDROP ------- */
    #modalBackdrop {
      display: none;
      position: fixed;
      z-index: 1005;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.7);
    }
    #urlModal {
      display: none;
      position: fixed;
      z-index: 1010;
      left: 50%; top: 50%;
      transform: translate(-50%,-50%);
      width: 90%; max-width: 1200px;
      background: #555;
      padding: 25px;
      box-sizing: border-box;
      border-radius: 12px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.5);
    }
    #urlModal h3 {
      margin-top: 0;
      text-align: center;
      color: #fff;
      margin-bottom: 15px;
    }
    #urlModal textarea {
      width: 100%;
      height: 400px;
      padding: 15px;
      font-size: 14px;
      box-sizing: border-box;
      border-radius: 8px;
      border: 1px solid #666;
      background-color: #f8f8f8;
      color: #333;
      margin-bottom: 15px;
      resize: vertical;
      -webkit-overflow-scrolling: touch;
    }
    #urlModal button {
      width: auto;
      padding: 12px 25px;
      font-size: 16px;
      display: block;
      margin: 0 auto;
    }

    /* ----- MOBILE SIDEBAR ----- */
    html.mobile #urlModal {
      width: 90vw;
      max-width: 400px;
      padding: 15px;
      font-size: 14px;
    }
    html.mobile #urlModal textarea {
      height: 200px;
      padding: 10px;
      font-size: 14px;
    }
    html.mobile #sidebar {
      position: fixed;
      top: 0; left: 0;
      height: 100%;
      border-radius: 0 8px 8px 0;
      box-shadow: 3px 0 10px rgba(0,0,0,0.3);
    }
    #sidebarToggle {
      display: none;
      position: fixed;
      top: 20px; left: 10px;
      z-index: 1100;
      background: #444;
      border: none;
      width: 40px; height: 40px;
      font-size: 20px;
      line-height: 40px;
      text-align: center;
      color: #fff;
      cursor: pointer;
      border-radius: 50%;
      box-shadow: 0 2px 5px rgba(0,0,0,0.3);
    }

    /* ----- MOBILE ROOT SCROLL OVERRIDE ----- */
    html.mobile .container {
      height: 100vh!important;
    }
    html.mobile:not(.pseudo-fullscreen-mobile) {
      position: static!important;
      height: auto!important;
      overflow-y: auto!important;
      overflow-x: hidden!important;
    }
    html.mobile:not(.pseudo-fullscreen-mobile) body {
      position: static!important;
      height: auto!important;
      overflow: visible!important;
      min-height: 100vh;
    }
    html.mobile:not(.pseudo-fullscreen-mobile) .container {
      height: auto!important;
      min-height: 100vh!important;
      position: static!important;
      display: block!important;
    }
    html.mobile:not(.pseudo-fullscreen-mobile) #main-content {
      height: auto!important;
      min-height: calc(100vh - 60px);
      overflow: visible!important;
      display: block!important;
    }

    /* ------ MOBILE NON-FULLSCREEN PLAYER ------ */
    html.mobile .player-container.mobile:not(.player-fullscreen-mobile) .canvas-wrapper,
    html.mobile .player-container.mobile:not(.player-fullscreen-mobile) .display-canvas {
      display: none!important;
    }
    html.mobile .player-container.mobile:not(.player-fullscreen-mobile) .controls-container {
      display: block!important;
      position: relative;
      background: #222;
      border-radius: 0 0 12px 12px;
      padding: 0;
    }
    html.mobile .player-container.mobile:not(.player-fullscreen-mobile) .progress-bar,
    html.mobile .player-container.mobile:not(.player-fullscreen-mobile) .reset-btn,
    html.mobile .player-container.mobile:not(.player-fullscreen-mobile) .disable-btn {
      display: none!important;
    }
    html.mobile .player-container.mobile:not(.player-fullscreen-mobile) .control-bar {
      justify-content: space-between;
      padding: 8px 12px;
      background: none;
    }
    html.mobile .player-container.mobile:not(.player-fullscreen-mobile) .fs-btn-mobile {
      display: inline-block;
    }

    .video-title-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px 12px;
      background: rgba(0,0,0,0.6);
      color: #eee;
      font-size: 14px;
      border-bottom: 1px solid #444;
    }
    .fs-btn-mobile {
      cursor: pointer;
      background: none;
      color: #fff;
      border: none;
      padding: 4px 8px;
      font-size: 20px;
      line-height: 1;
      flex-shrink: 0;
    }
    .video-title-row span {
      flex-grow: 1;
      text-align: center;
      margin: 0 10px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* ---------- MOBILE PSEUDO-FULLSCREEN ---------- */
    html.pseudo-fullscreen-mobile {
      position: relative;
      overflow: hidden!important;
      height: 100vh!important;
    }
    html.pseudo-fullscreen-mobile.non-safari {
      overflow-y: scroll!important;
      height: auto!important;
      min-height: 105vh;
    }
    html.pseudo-fullscreen-mobile body {
      overflow: visible!important;
      height: auto!important;
      position: static!important;
      min-height: 105vh;
    }
    html.pseudo-fullscreen-mobile .container {
      height: auto!important;
      min-height: 105vh;
      position: static!important;
      display: block!important;
    }
    html.pseudo-fullscreen-mobile #main-content {
      height: auto!important;
      min-height: 105vh;
      display: block!important;
    }

    .player-container.player-fullscreen-mobile {
      position: fixed!important;
      top: 0; left: 0;
      width: 100vw!important;
      height: 100vh!important;
      max-width: none!important;
      margin: 0!important;
      border-radius: 0!important;
      background-color: #000!important;
      z-index: 2000!important;
      overflow: hidden;
    }
    .player-container.player-fullscreen-mobile .source-video {
      position: absolute;
      top: 0; left: 0;
      width: 100%;
      height: 100%;
      object-fit: contain;
      border-radius: 0;
      transform-origin: center center;
      transform: scale(1) translate(0px, 0px);
      cursor: grab;
      will-change: transform;
    }
    .player-container.player-fullscreen-mobile .source-video:active {
      cursor: grabbing;
    }
    .player-container.player-fullscreen-mobile .video-title-row,
    .player-container.player-fullscreen-mobile .controls-container:not(.fullscreen-controls) {
      display: none!important;
    }
    .player-container.player-fullscreen-mobile .fullscreen-controls {
      display: block!important;
    }

    .fullscreen-controls {
      display: none;
      position: absolute;
      bottom: -120px;
      left: 50%;
      transform: translateX(-50%);
      width: 90%;
      max-width: 500px;
      z-index: 2100;
      transition: bottom 0.3s ease-in-out;
      border-radius: 10px;
      background-color: rgba(0,0,0,0.8);
      box-sizing: border-box;
      padding-bottom: env(safe-area-inset-bottom,10px);
    }
    .player-container.controls-open .fullscreen-controls {
      bottom: 10px;
    }
    .fullscreen-controls .control-bar {
      padding: 10px 15px;
      gap: 15px;
    }
    .fullscreen-controls .progress-bar {
      display: flex!important;
    }

    /* PWA Standalone Adjustments */
    @media all and (display-mode: standalone) {
      html.mobile body {
        padding-top: env(safe-area-inset-top,0px);
      }
      html.mobile #sidebarToggle {
        top: calc(20px + env(safe-area-inset-top,0px));
      }
      html.mobile #main-content {
        padding-top: 60px;
        padding-bottom: env(safe-area-inset-bottom,0px);
        height: calc(100vh - env(safe-area-inset-top,0px));
        box-sizing: border-box;
      }
      .player-container.controls-open .fullscreen-controls {
        bottom: env(safe-area-inset-bottom,10px);
      }
    }
  </style>

  <script>
    // PWA tags for Safari Mobile (no changes)
    (function(){
      const ua = navigator.userAgent;
      const isSafariMobile = /iPhone|iPad|iPod/.test(ua) && /AppleWebKit/.test(ua) && !/CriOS/.test(ua) && !/FxiOS/.test(ua);
      if (isSafariMobile) {
        const head = document.head;
        let m1 = document.createElement('meta');
        m1.name = 'apple-mobile-web-app-capable';
        m1.content = 'yes';
        head.appendChild(m1);
        let m2 = document.createElement('meta');
        m2.name = 'apple-mobile-web-app-status-bar-style';
        m2.content = 'black-translucent';
        head.appendChild(m2);
        let m3 = document.createElement('meta');
        m3.name = 'apple-mobile-web-app-title';
        m3.content = 'Live DVR';
        head.appendChild(m3);
        console.log("Safari Mobile detected: Added PWA meta tags.");
      }
    })();

    const IS_MOBILE = /Mobi|Android|iPhone|iPad/i.test(navigator.userAgent);
    const IS_SAFARI_MOBILE = IS_MOBILE && /iPhone|iPad|iPod/.test(navigator.userAgent) && /AppleWebKit/.test(navigator.userAgent) && !/CriOS/.test(navigator.userAgent) && !/FxiOS/.test(navigator.userAgent);
    if (IS_MOBILE) {
      document.documentElement.classList.add("mobile");
      if (IS_SAFARI_MOBILE) document.documentElement.classList.add("safari-mobile");
      else document.documentElement.classList.add("non-safari-mobile");
    }

    // Spacebar & cursor auto-hide (no changes)
    let spaceHeld = false;
    window.addEventListener("keydown", e => {
      if (e.code === "Space" && !["input","textarea","button"].includes(document.activeElement.tagName.toLowerCase())) {
        e.preventDefault(); spaceHeld = true;
      }
    });
    window.addEventListener("keyup", e => { if (e.code === "Space") spaceHeld = false; });

    let cursorTimeout;
    function showCursor(){ document.body.style.cursor = ""; }
    function hideCursor(){ document.body.style.cursor = "none"; }
    document.addEventListener("fullscreenchange", () => {
      if (document.fullscreenElement) {
        showCursor();
        clearTimeout(cursorTimeout);
        cursorTimeout = setTimeout(hideCursor,3000);
      } else {
        showCursor();
        clearTimeout(cursorTimeout);
      }
    });
    document.addEventListener("mousemove", () => {
      if (document.fullscreenElement) {
        showCursor();
        clearTimeout(cursorTimeout);
        cursorTimeout = setTimeout(hideCursor,3000);
      }
    });

    function hideBrowserUI(){
      if (!window.matchMedia('(display-mode: standalone)').matches && !IS_SAFARI_MOBILE){
        setTimeout(()=>{
          const htmlScrollable = document.documentElement.scrollHeight > document.documentElement.clientHeight;
          if (htmlScrollable) document.documentElement.scrollTop = 1;
          else window.scrollTo(0,1);
        },300);
      }
    }
  </script>
</head>

<body>
  <button id="sidebarToggle">&#x2630;</button>
  <div class="container">
    <div id="sidebar">
      <button id="btn-add-urls">Add URLs</button>
      <div id="sideButtons">
        <button id="btn-show-all" class="sideBtn">Show All</button>
        <button id="btn-hide-all" class="sideBtn">Hide All</button>
      </div>
      <div id="streamList">
        <p class="no-streams">Loading streams...</p>
      </div>
    </div>
    <div id="main-content"></div>
  </div>
  <div id="modalBackdrop"></div>
  <div id="urlModal">
    <h3>Paste Playlist URLs (one per line)</h3>
    <textarea id="urlInput" placeholder="https://…/playlist.m3u8"></textarea>
    <button id="saveUrls">Save and Close</button>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  <script>
    function enterNativeFullScreen(el){
      if (document.fullscreenElement||document.webkitFullscreenElement) return Promise.resolve();
      const r = el.requestFullscreen||el.webkitRequestFullscreen||el.mozRequestFullScreen||el.msRequestFullscreen;
      if (r) return r.call(el).catch(err=>console.error("Fullscreen failed:",err));
      else return Promise.reject("No Fullscreen API");
    }
    function exitNativeFullScreen(){
      if (!document.fullscreenElement&&!document.webkitFullscreenElement) return Promise.resolve();
      const e = document.exitFullscreen||document.webkitExitFullscreen||document.mozCancelFullScreen||document.msExitFullscreen;
      if (e) return e.call(document).catch(err=>console.error("Exit fullscreen failed:",err));
      else return Promise.reject("No Exit FS");
    }

    const PROXY_PREFIX = "https://surfcam-alpha.vercel.app/api/proxy?url=";
    const PLAYER_SETTINGS_KEY = "liveDvrPlayerSettings_v1";
    const STREAM_CONFIGS_KEY  = "liveDvrStreamConfigs_v1";

    function loadPlayerSettings(url){
      try {
        const all = JSON.parse(localStorage.getItem(PLAYER_SETTINGS_KEY)||"{}");
        return all[url]||{zoomScale:1,panX:0,panY:0};
      } catch { return {zoomScale:1,panX:0,panY:0}; }
    }
    function savePlayerSettings(url,data){
      try {
        let all = JSON.parse(localStorage.getItem(PLAYER_SETTINGS_KEY)||"{}");
        all[url]=data;
        localStorage.setItem(PLAYER_SETTINGS_KEY,JSON.stringify(all));
      }catch{}
    }
    function getStreamList(){
      try {
        const stored = localStorage.getItem(STREAM_CONFIGS_KEY);
        if (!stored) return [];
        const parsed = JSON.parse(stored);
        if (!Array.isArray(parsed) || !parsed.every(i=>typeof i==='object'&&'url' in i&&'enabled' in i)){
          localStorage.removeItem(STREAM_CONFIGS_KEY);
          return [];
        }
        return parsed;
      }catch{
        localStorage.removeItem(STREAM_CONFIGS_KEY);
        return [];
      }
    }
    function saveStreamList(list){
      try {
        if (!Array.isArray(list)||!list.every(i=>typeof i==='object'&&'url' in i&&'enabled' in i)) return;
        localStorage.setItem(STREAM_CONFIGS_KEY,JSON.stringify(list));
      }catch{}
    }

    function extractTitle(url){
      const m = url.match(/wc-([^\/]+)\/playlist/);
      return m?m[1]:url;
    }
    function clampPan(container){
      const Z = container.zoomScale;
      const W = 960, H = 540;
      if (Z<=1){
        container.panX=0; container.panY=0; return;
      }
      const mx = (W*(Z-1))/(2*Z);
      const my = (H*(Z-1))/(2*Z);
      container.panX = Math.min(mx,Math.max(-mx,container.panX));
      container.panY = Math.min(my,Math.max(-my,container.panY));
    }
    function getTouchDistance(t1,t2){
      const dx = t1.clientX - t2.clientX;
      const dy = t1.clientY - t2.clientY;
      return Math.hypot(dx,dy);
    }
    function getTouchMidpoint(t1,t2){
      return { x:(t1.clientX+t2.clientX)/2, y:(t1.clientY+t2.clientY)/2 };
    }

    const sidebar      = document.getElementById("sidebar");
    const sidebarToggle= document.getElementById("sidebarToggle");
    const streamListCt = document.getElementById("streamList");
    const mainContent  = document.getElementById("main-content");
    const modalBackdrop= document.getElementById("modalBackdrop");
    const urlModal     = document.getElementById("urlModal");
    const urlInput     = document.getElementById("urlInput");
    const saveUrlsBtn  = document.getElementById("saveUrls");
    const btnAddUrls   = document.getElementById("btn-add-urls");
    const btnShowAll   = document.getElementById("btn-show-all");
    const btnHideAll   = document.getElementById("btn-hide-all");

    let activeSidebarLabels = new Set();
    let sidebarDragStartState = null;
    let isSidebarDragging = false;
    let players = {};

    function updateStreamSidebar(){
      streamListCt.innerHTML = "";
      const streams = getStreamList();
      if (!streams.length){
        const p = document.createElement("p");
        p.className = "no-streams";
        p.textContent = "No streams added. Click 'Add URLs'.";
        streamListCt.appendChild(p);
      } else {
        streams.forEach(stream=>{
          const item = document.createElement("div");
          item.className = "stream-item";
          const cb = document.createElement("input");
          cb.type = "checkbox";
          cb.checked = stream.enabled;
          cb.dataset.url = stream.url;
          cb.id = `cb-${encodeURIComponent(stream.url)}`;
          cb.addEventListener("change", e=>{
            updateStreamEnabled(stream.url, e.target.checked);
          });
          item.appendChild(cb);
          const label = document.createElement("label");
          label.textContent = extractTitle(stream.url);
          label.htmlFor = cb.id;
          label.dataset.url = stream.url;
          label.addEventListener("mousedown", e=>{
            if (e.button===0){
              e.preventDefault();
              isSidebarDragging = true;
              sidebarDragStartState = cb.checked;
              activeSidebarLabels.clear();
              activeSidebarLabels.add(label);
              item.classList.add('selecting');
            }
          });
          label.addEventListener("mouseenter", e=>{
            if (isSidebarDragging && (e.buttons&1)){
              activeSidebarLabels.add(label);
              item.classList.add('selecting');
            }
          });
          item.appendChild(label);
          streamListCt.appendChild(item);
        });
      }
    }
    document.addEventListener("mouseup", e=>{
      if (e.button===0 && isSidebarDragging){
        isSidebarDragging = false;
        const toToggle = new Set(activeSidebarLabels);
        activeSidebarLabels.clear();
        document.querySelectorAll('.stream-item.selecting').forEach(el=>el.classList.remove('selecting'));
        if (toToggle.size){
          const target = !sidebarDragStartState;
          toToggle.forEach(label=>{
            const url = label.dataset.url;
            const cb  = document.getElementById(`cb-${encodeURIComponent(url)}`);
            if (cb){
              cb.checked = target;
              updateStreamEnabled(url, target);
            }
          });
        }
        sidebarDragStartState = null;
      }
    });
    streamListCt.addEventListener('contextmenu', e=>{ if (isSidebarDragging) e.preventDefault(); });

    function reorderPlayers(){
      const streams = getStreamList();
      const sorted = Array.from(mainContent.children)
        .filter(el=>el.classList.contains('player-container'))
        .sort((a,b)=>{
          const iA = streams.findIndex(s=>s.url===a.dataset.url);
          const iB = streams.findIndex(s=>s.url===b.dataset.url);
          if (iA===-1) return 1;
          if (iB===-1) return -1;
          return iA - iB;
        });
      sorted.forEach(el=>mainContent.appendChild(el));
    }
    function updateStreamEnabled(url, enabled){
      let streams = getStreamList();
      const idx = streams.findIndex(s=>s.url===url);
      if (idx===-1) return;
      streams[idx].enabled = enabled;
      saveStreamList(streams);
      const existing = players[url];
      if (enabled){
        if (!existing){
          const built = createPlayerContainer(streams[idx]);
          if (built){
            mainContent.appendChild(built.container);
            players[url] = built;
          }
        } else {
          if (!existing.container.isConnected) mainContent.appendChild(existing.container);
          existing.container.style.display="flex";
          if (existing.hls && !existing.hls.media) existing.hls.attachMedia(existing.video);
          if (existing.hls) existing.hls.startLoad();
          else if (existing.video.src && existing.video.paused) existing.video.play().catch(()=>{});
          if (existing.video.autoplay || !existing.video.paused) existing.video.play().catch(()=>{});
        }
      } else {
        if (existing){
          if (existing.hls) existing.hls.destroy();
          existing.video.pause();
          existing.video.removeAttribute('src');
          existing.video.load();
          if (existing.animationFrameId) cancelAnimationFrame(existing.animationFrameId);
          if (existing.container.classList.contains('player-fullscreen-mobile')){
            exitPseudoFullscreen(existing.container, existing.video);
          }
          existing.container.remove();
          delete players[url];
        }
      }
      reorderPlayers();
      updateStreamSidebar();
    }

    function createPlayerContainer(stream){
      if (!stream || !stream.enabled) return null;
      const url = stream.url;
      const saved = loadPlayerSettings(url);
      const container = document.createElement("div");
      container.className = `player-container ${IS_MOBILE?"mobile":"desktop"}`;
      container.dataset.url = url;
      container.zoomScale = saved.zoomScale;
      container.panX = saved.panX;
      container.panY = saved.panY;

      const video = document.createElement("video");
      video.className = "source-video";
      video.setAttribute("playsinline","");
      video.setAttribute("webkit-playsinline","");
      video.setAttribute("crossorigin","anonymous");
      video.muted = true;
      video.preload = "metadata";
      video.autoplay = true;

      let hlsInstance = null;
      let animationFrameId = null;
      const isMp4     = url.toLowerCase().endsWith('.mp4');
      const title     = extractTitle(url);

      if (isMp4){
        /* MP4 branch (no changes) */
        container.classList.add('mp4-player');
        video.controls = true;
        video.muted    = false;
        video.autoplay = false;
        video.src = PROXY_PREFIX + encodeURIComponent(url);
        container.appendChild(video);
        const ctr = document.createElement("div");
        ctr.className = "controls-container";
        const tb  = document.createElement("div");
        tb.className = "title-bar";
        tb.textContent = title;
        ctr.appendChild(tb);
        container.appendChild(ctr);
        video.addEventListener('error',e=>{
          tb.textContent = `Error: ${video.error?.message||'Could not load video'}`;
          tb.style.color='red';
        });
        if (IS_MOBILE){
          let lastTap=0;
          container.addEventListener("click",e=>{
            if (e.target.closest('video[controls]')) return;
            const now=Date.now();
            if (now-lastTap<350){ enterPseudoFullscreen(container,video); lastTap=0; }
            else lastTap=now;
          });
        }else{
          let lastTap=0;
          container.addEventListener("click",e=>{
            if (e.target.closest('video[controls]')) return;
            const now=Date.now();
            if (now-lastTap<300){
              if (!document.fullscreenElement && !document.webkitFullscreenElement) enterNativeFullScreen(container);
              else exitNativeFullScreen();
              lastTap=0;
            } else lastTap=now;
          });
        }

      } else if (IS_MOBILE){
        /* Mobile HLS branch (no changes) */
        video.controls = false;
        const titleRow = document.createElement("div");
        titleRow.className = "video-title-row";
        const titleSpan = document.createElement("span");
        titleSpan.textContent = title;
        const fsBtnMobile = document.createElement("button");
        fsBtnMobile.className = "fs-btn-mobile";
        fsBtnMobile.innerHTML = "&#x26F6;";
        fsBtnMobile.setAttribute("aria-label","Enter Fullscreen");
        titleRow.appendChild(titleSpan);
        titleRow.appendChild(fsBtnMobile);
        container.appendChild(titleRow);
        container.appendChild(video);
        const ctrM = document.createElement("div");
        ctrM.className = "controls-container";
        const cbM  = document.createElement("div");
        cbM.className = "control-bar";
        const ppM  = document.createElement("button");
        ppM.textContent = "Play";
        ppM.setAttribute("aria-label","Play/Pause");
        cbM.appendChild(ppM);
        ctrM.appendChild(cbM);
        container.appendChild(ctrM);

        let lastTap=0;
        container.addEventListener("click",e=>{
          if (e.target.closest('.controls-container')) return;
          const now=Date.now();
          const dt=now-lastTap;
          if (dt<350){ enterPseudoFullscreen(container,video); lastTap=0; }
          else {
            if (video.paused) video.play().catch(()=>{});
            else video.pause();
            lastTap=now;
          }
        });
        ppM.addEventListener("click",e=>{
          e.stopPropagation();
          if (video.paused) video.play().catch(()=>{});
          else video.pause();
        });
        fsBtnMobile.addEventListener("click",e=>{
          e.stopPropagation();
          enterPseudoFullscreen(container,video);
        });
        video.addEventListener("play", ()=>ppM.textContent="Pause");
        video.addEventListener("pause",()=>ppM.textContent="Play");
        video.addEventListener("ended",()=>ppM.textContent="Play");
        video.addEventListener("canplay",()=>{
          if (video.paused) video.play().catch(e=>console.log(`Autoplay failed for ${url}:`,e));
        },{once:true});

      } else {
        /* Desktop HLS + Canvas branch */
        const canvasWrapper = document.createElement("div");
        canvasWrapper.className = "canvas-wrapper";
        container.appendChild(canvasWrapper);
        const canvas = document.createElement("canvas");
        canvas.className = "display-canvas";
        canvas.width = 960;
        canvas.height= 540;
        canvasWrapper.appendChild(canvas);

        const controlsContainer = document.createElement("div");
        controlsContainer.className = "controls-container";
        container.appendChild(controlsContainer);

        /* Privates UI toggle (no DOM overlays) */
        if (title === 'privates'){
          // Preload images
          const minorImg = new Image();
          minorImg.src = "https://devenf23.github.io/surfcam/privates/Jack's/Jack's_minor.png";
          const textImg = new Image();
          textImg.src = "https://devenf23.github.io/surfcam/privates/Jack's/Jack's_text.png";
          const majorImg = new Image();
          majorImg.src = "https://devenf23.github.io/surfcam/privates/Jack's/Jack's_major.png";
          container.overlays = {
            minor: false,
            text:  false,
            mask:  false,
            minorImg,
            textImg,
            majorImg
          };

          // Gear button
          const overlayIcon = document.createElement('button');
          overlayIcon.className = 'overlay-icon';
          overlayIcon.innerHTML = '⚙️';
          overlayIcon.title = 'Spot Overlays';
          canvasWrapper.appendChild(overlayIcon);

          // Right sidebar
          const rightSidebar = document.createElement('div');
          rightSidebar.className = 'right-sidebar';
          rightSidebar.innerHTML = `
            <h4>Spot Features</h4>
            <ul>
              <li><input type="checkbox" id="cb-${encodeURIComponent(url)}-pp"><label for="cb-${encodeURIComponent(url)}-pp">Pleasure Point</label></li>
              <li><input type="checkbox" id="cb-${encodeURIComponent(url)}-jacks"><label for="cb-${encodeURIComponent(url)}-jacks">Jack's</label></li>
              <li><input type="checkbox" id="cb-${encodeURIComponent(url)}-hook"><label for="cb-${encodeURIComponent(url)}-hook">The Hook</label></li>
              <li><input type="checkbox" id="cb-${encodeURIComponent(url)}-sharks"><label for="cb-${encodeURIComponent(url)}-sharks">Sharks</label></li>
              <li><input type="checkbox" id="cb-${encodeURIComponent(url)}-inbetweens"><label for="cb-${encodeURIComponent(url)}-inbetweens">In-betweens</label></li>
              <li><input type="checkbox" id="cb-${encodeURIComponent(url)}-privates"><label for="cb-${encodeURIComponent(url)}-privates">Privates</label></li>
            </ul>`;
          container.appendChild(rightSidebar);

          overlayIcon.addEventListener('click', e=>{
            e.stopPropagation();
            rightSidebar.classList.toggle('visible');
          });

          const jacksCb = rightSidebar.querySelector(`#cb-${encodeURIComponent(url)}-jacks`);
          if (jacksCb){
            jacksCb.addEventListener('change', e=>{
              const on = e.target.checked;
              container.overlays.mask  = on;
              container.overlays.minor = on;
              container.overlays.text  = on;
            });
          } else {
            console.error(`Could not find Jack's checkbox for ${url}`);
          }

          container.addEventListener('click', e=>{
            if (rightSidebar.classList.contains('visible') &&
                !rightSidebar.contains(e.target) &&
                e.target !== overlayIcon){
              rightSidebar.classList.remove('visible');
            }
          });
        }

        // Hidden video element
        container.appendChild(video);

        const ctx = canvas.getContext("2d");
        function renderCanvas(){
          if (video.readyState >= video.HAVE_METADATA && container.isConnected){
            clampPan(container);
            ctx.save();
            // clear
            ctx.fillStyle = '#000';
            ctx.fillRect(0,0,canvas.width,canvas.height);

            if (video.videoWidth > 0 && video.videoHeight > 0){
              const canvasAspect = canvas.width/canvas.height;
              const videoAspect  = video.videoWidth/video.videoHeight;
              let drawWidth, drawHeight, offsetX, offsetY;
              if (canvasAspect > videoAspect){
                drawHeight = canvas.height;
                drawWidth  = drawHeight*videoAspect;
                offsetX    = (canvas.width - drawWidth)/2;
                offsetY    = 0;
              } else {
                drawWidth  = canvas.width;
                drawHeight = drawWidth/videoAspect;
                offsetX    = 0;
                offsetY    = (canvas.height - drawHeight)/2;
              }

              const centerX = canvas.width/2;
              const centerY = canvas.height/2;

              // pan/zoom transforms
              ctx.translate(centerX,centerY);
              ctx.scale(container.zoomScale,container.zoomScale);
              ctx.translate(container.panX,container.panY);
              ctx.translate(-centerX,-centerY);

              // draw video
              try {
                ctx.drawImage(video, offsetX, offsetY, drawWidth, drawHeight);
              } catch (err){
                console.error("Draw Error:",err);
              }

              // overlay logic
              const ov = container.overlays;
              if (ov && ov.mask){
                ctx.save();
                ctx.globalCompositeOperation = 'source-over';
                ctx.filter = 'blur(3px)';
                ctx.fillStyle = 'rgba(0,0,0,0.4)';
                ctx.fillRect(offsetX, offsetY, drawWidth, drawHeight);
                ctx.filter = 'none';
                ctx.globalCompositeOperation = 'destination-out';
                ctx.drawImage(ov.majorImg, offsetX, offsetY, drawWidth, drawHeight);
                ctx.restore();
                ctx.globalCompositeOperation = 'source-over';
              }
              if (ov && ov.minor){
                ctx.drawImage(ov.minorImg, offsetX, offsetY, drawWidth, drawHeight);
              }
              if (ov && ov.text){
                ctx.drawImage(ov.textImg, offsetX, offsetY, drawWidth, drawHeight);
              }
            } else {
              ctx.fillStyle = '#555';
              ctx.textAlign = 'center';
              ctx.fillText('Loading...', canvas.width/2, canvas.height/2);
            }
            ctx.restore();
          }
          if (container.isConnected){
            animationFrameId = requestAnimationFrame(renderCanvas);
          } else {
            animationFrameId = null;
          }
        }

        video.addEventListener("canplay", ()=>{
          if (!animationFrameId && container.isConnected) renderCanvas();
        });
        video.addEventListener('emptied', ()=>{
          if (animationFrameId) cancelAnimationFrame(animationFrameId);
          animationFrameId = null;
        });
        video.addEventListener('error', ()=>{
          if (animationFrameId) cancelAnimationFrame(animationFrameId);
          animationFrameId = null;
        });

        // --- Desktop controls & interactions (unchanged) ---
        let startX, startY, isDragging = false;
        canvasWrapper.addEventListener("mousedown", e=>{
          const isFs = document.fullscreenElement===container || document.webkitFullscreenElement===container;
          if (e.button===0 && (spaceHeld||isFs)){
            startX = e.clientX;
            startY = e.clientY;
            isDragging = false;
            container.style.cursor='grabbing';
            e.preventDefault();
          }
        });
        document.addEventListener("mousemove", e=>{
          const isFs = document.fullscreenElement===container || document.webkitFullscreenElement===container;
          if ((e.buttons&1) && (spaceHeld||isFs) && typeof startX==='number'){
            const dx = e.clientX - startX;
            const dy = e.clientY - startY;
            if (!isDragging && Math.hypot(dx,dy)>5) isDragging = true;
            if (isDragging){
              container.panX += dx/container.zoomScale;
              container.panY += dy/container.zoomScale;
              clampPan(container);
              savePlayerSettings(url,{zoomScale:container.zoomScale,panX:container.panX,panY:container.panY});
              startX = e.clientX;
              startY = e.clientY;
            }
          }
        });
        document.addEventListener("mouseup", e=>{
          if (e.button===0 && typeof startX==='number'){
            container.style.cursor='';
            startX = null;
            startY = null;
            setTimeout(()=>isDragging=false,0);
          }
        });
        canvasWrapper.addEventListener("wheel", e=>{
          const isFs = document.fullscreenElement===container || document.webkitFullscreenElement===container;
          if (spaceHeld||isFs){
            e.preventDefault();
            const rect = canvasWrapper.getBoundingClientRect();
            const mx = e.clientX - rect.left;
            const my = e.clientY - rect.top;
            const normX = mx/rect.width;
            const normY = my/rect.height;
            const canvasX = normX*960;
            const canvasY = normY*540;
            const oldZoom = container.zoomScale;
            const zoomAmt = 0.15;
            let newZoom = oldZoom*(e.deltaY<0?(1+zoomAmt):(1/(1+zoomAmt)));
            newZoom = Math.max(1,Math.min(5,newZoom));
            if (newZoom!==oldZoom){
              container.panX += (canvasX-480)*(1/newZoom - 1/oldZoom);
              container.panY += (canvasY-270)*(1/newZoom - 1/oldZoom);
              container.zoomScale = newZoom;
              clampPan(container);
              savePlayerSettings(url,{zoomScale:container.zoomScale,panX:container.panX,panY:container.panY});
            }
          }
        },{passive:false});

        let clickTimeout=null, lastClickTime=0;
        const handleDesktopClick = e=>{
          const isFs = document.fullscreenElement===container || document.webkitFullscreenElement===container;
          if (e.target.closest('.overlay-icon')||e.target.closest('.right-sidebar')) return;
          if (!isFs && e.target!==canvasWrapper && !canvasWrapper.contains(e.target)) return;
          if (e.button!==0 || isDragging) return;
          const now=Date.now();
          if (now-lastClickTime<300){
            clearTimeout(clickTimeout);
            lastClickTime=0;
            if (!isFs) enterNativeFullScreen(container);
            else exitNativeFullScreen();
          } else {
            clickTimeout = setTimeout(()=>{
              if (e.target===canvasWrapper||canvasWrapper.contains(e.target)){
                if (video.paused) video.play().catch(()=>{});
                else video.pause();
              }
            },300);
          }
          lastClickTime=now;
        };
        container.addEventListener("click", handleDesktopClick);

        /* Desktop control bar creation (unchanged) */
        const controlBar = document.createElement("div");
        controlBar.className = "control-bar";
        controlsContainer.appendChild(controlBar);
        const playPauseBtn = document.createElement("button");
        playPauseBtn.textContent = video.paused?"Play":"Pause";
        playPauseBtn.setAttribute("aria-label","Play/Pause");
        playPauseBtn.addEventListener("click",e=>{
          e.stopPropagation();
          if (video.paused) video.play().catch(()=>{});
          else video.pause();
        });
        video.addEventListener("play",()=>playPauseBtn.textContent="Pause");
        video.addEventListener("pause",()=>playPauseBtn.textContent="Play");
        video.addEventListener("ended",()=>playPauseBtn.textContent="Play");
        controlBar.appendChild(playPauseBtn);

        const progressBar = document.createElement("div");
        progressBar.className = "progress-bar";
        const bufferedBar = document.createElement("div");
        bufferedBar.className = "buffered";
        const playedBar = document.createElement("div");
        playedBar.className = "played";
        const thumb = document.createElement("div");
        thumb.className = "thumb";
        progressBar.appendChild(bufferedBar);
        progressBar.appendChild(playedBar);
        progressBar.appendChild(thumb);
        controlBar.appendChild(progressBar);

        function updateProgressBar(){
          const d = video.duration;
          if (!isNaN(d)&&d>0&&isFinite(d)){
            const ct      = video.currentTime;
            const buf     = video.buffered;
            let bufEnd = 0;
            try {
              for (let i=0;i<buf.length;i++){
                if (buf.start(i)<=ct && buf.end(i)>=ct){
                  bufEnd = buf.end(i); break;
                }
                bufEnd = Math.max(bufEnd, buf.end(i));
              }
            }catch{}
            const pp = (ct/d)*100;
            const bp = (bufEnd/d)*100;
            playedBar.style.width   = `${Math.min(100,pp)}%`;
            thumb.style.left        = `${Math.min(100,pp)}%`;
            bufferedBar.style.width = `${Math.min(100,bp)}%`;
          } else {
            playedBar.style.width   = '0%';
            thumb.style.left        = '0%';
            bufferedBar.style.width = '0%';
          }
        }
        ["timeupdate","progress","loadedmetadata","durationchange"].forEach(evt=>{
          video.addEventListener(evt,updateProgressBar);
        });
        updateProgressBar();

        let isSeeking=false;
        function seek(event){
          const d = video.duration;
          if (!isNaN(d)&&d>0&&isFinite(d)){
            const pr = progressBar.getBoundingClientRect();
            let cX = event.clientX;
            if (event.type.startsWith('touch')){
              if (event.touches.length>0) cX = event.touches[0].clientX;
              else if (event.changedTouches.length>0) cX = event.changedTouches[0].clientX;
            }
            const clickX = cX - pr.left;
            let sp = clickX/pr.width;
            sp = Math.max(0,Math.min(1,sp));
            const st = sp*d;
            let canSeek=false;
            try {
              for (let i=0;i<video.seekable.length;i++){
                if (st>=video.seekable.start(i) && st<=video.seekable.end(i)){
                  canSeek=true; break;
                }
              }
            }catch{ canSeek=true; }
            if (canSeek){
              video.currentTime = st;
              updateProgressBar();
            }
          }
        }
        progressBar.addEventListener("mousedown", e=>{
          if (e.button===0){
            isSeeking=true;
            document.body.style.userSelect='none';
            seek(e);
            progressBar.style.cursor='grabbing';
          }
        });
        progressBar.addEventListener("touchstart", e=>{
          isSeeking=true;
          document.body.style.webkitUserSelect='none';
          seek(e);
        },{passive:true});
        document.addEventListener("mousemove", e=>{ if (isSeeking) seek(e); });
        document.addEventListener("touchmove", e=>{
          if (isSeeking){
            e.preventDefault();
            seek(e);
          }
        },{passive:false});
        document.addEventListener("mouseup", e=>{
          if (e.button===0 && isSeeking){
            isSeeking=false;
            progressBar.style.cursor='pointer';
            document.body.style.userSelect='';
          }
        });
        document.addEventListener("touchend", e=>{
          if (isSeeking){
            isSeeking=false;
            document.body.style.webkitUserSelect='';
          }
        });

        const fsBtnDesktop = document.createElement("button");
        fsBtnDesktop.innerHTML = "&#x26F6;";
        fsBtnDesktop.setAttribute("aria-label","Enter/Exit Fullscreen");
        fsBtnDesktop.addEventListener("click", e=>{
          e.stopPropagation();
          if (!document.fullscreenElement && !document.webkitFullscreenElement) enterNativeFullScreen(container);
          else exitNativeFullScreen();
        });
        controlBar.appendChild(fsBtnDesktop);
        function updateFsBtn(){
          const isFs = document.fullscreenElement===container || document.webkitFullscreenElement===container;
          fsBtnDesktop.innerHTML = isFs?"&#x2921;":"&#x26F6;";
        }
        document.addEventListener("fullscreenchange", updateFsBtn);
        document.addEventListener("webkitfullscreenchange", updateFsBtn);

        const resetBtn = document.createElement("button");
        resetBtn.textContent = "Reset";
        resetBtn.setAttribute("aria-label","Reset Pan & Zoom");
        resetBtn.addEventListener("click", e=>{
          e.stopPropagation();
          container.zoomScale=1;
          container.panX=0;
          container.panY=0;
          savePlayerSettings(url,{zoomScale:1,panX:0,panY:0});
        });
        controlBar.appendChild(resetBtn);

        const disableBtn = document.createElement("button");
        disableBtn.className = "disable-btn";
        disableBtn.textContent = "✕";
        disableBtn.setAttribute("aria-label","Hide this stream");
        disableBtn.addEventListener("click", e=>{
          e.stopPropagation();
          updateStreamEnabled(url,false);
        });
        controlBar.appendChild(disableBtn);

        const tb = document.createElement("div");
        tb.className = "title-bar";
        tb.textContent = title;
        controlsContainer.appendChild(tb);

        /* Fullscreen auto-hide controls (no changes) */
        let hideControlsTimeout=null;
        function showControlsTemporarily(){
          const isFs = document.fullscreenElement===container || document.webkitFullscreenElement===container;
          if (!isFs) return;
          controlsContainer.style.opacity='1';
          controlsContainer.style.pointerEvents='auto';
          clearTimeout(hideControlsTimeout);
          if (!video.paused){
            hideControlsTimeout = setTimeout(()=>{
              controlsContainer.style.opacity='0';
              controlsContainer.style.pointerEvents='none';
            },3000);
          }
        }
        container.addEventListener('mousemove', showControlsTemporarily);
        container.addEventListener('mouseenter',showControlsTemporarily);
        video.addEventListener('pause', showControlsTemporarily);
        video.addEventListener('play', showControlsTemporarily);
        function setInitialControlsVisibility(){
          const isFs = document.fullscreenElement===container || document.webkitFullscreenElement===container;
          if (isFs) showControlsTemporarily();
          else {
            controlsContainer.style.opacity='1';
            controlsContainer.style.pointerEvents='auto';
            clearTimeout(hideControlsTimeout);
          }
        }
        document.addEventListener("fullscreenchange", setInitialControlsVisibility);
        document.addEventListener("webkitfullscreenchange", setInitialControlsVisibility);
      }

      /* HLS.js setup (no changes) */
      if (!isMp4){
        const preferNativeHls = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
        const canPlayNativeHls = video.canPlayType("application/vnd.apple.mpegurl");
        if (Hls.isSupported() && !preferNativeHls){
          hlsInstance = new Hls({
            maxBufferLength:60,
            maxMaxBufferLength:120,
            liveSyncDurationCount:3,
            fragLoadingTimeOut:20000,
            manifestLoadingTimeOut:20000,
            levelLoadingTimeOut:20000,
            progressive:true,
            loader: class extends Hls.DefaultConfig.loader {
              load(ctx,cfg,cb){
                let u = ctx.url;
                while (u.startsWith(PROXY_PREFIX)) u = decodeURIComponent(u.slice(PROXY_PREFIX.length));
                ctx.url = PROXY_PREFIX + encodeURIComponent(u);
                super.load(ctx,cfg,cb);
              }
            }
          });
          hlsInstance.loadSource(url);
          hlsInstance.attachMedia(video);
          hlsInstance.on(Hls.Events.MANIFEST_PARSED,()=>{
            if (video.autoplay || !video.paused) video.play().catch(()=>{});
          });
          hlsInstance.on(Hls.Events.ERROR,(ev,data)=>{
            console.error(`HLS Error: ${data.type}, ${data.details}`,data);
            if (data.fatal){
              switch(data.type){
                case Hls.ErrorTypes.NETWORK_ERROR:
                  setTimeout(()=>{ if(hlsInstance) hlsInstance.startLoad(); },2000);
                  break;
                case Hls.ErrorTypes.MEDIA_ERROR:
                  hlsInstance.recoverMediaError(); break;
                default:
                  hlsInstance.destroy();
                  setTimeout(()=>{
                    if (players[url] && players[url].container.isConnected)
                      updateStreamEnabled(url,true);
                  },5000);
                  break;
              }
            }
          });
        } else if (canPlayNativeHls){
          video.src = PROXY_PREFIX + encodeURIComponent(url);
          if (video.autoplay) video.play().catch(()=>{});
        } else {
          console.warn(`HLS not supported for ${url}`);
          const em=document.createElement('div');
          em.textContent = 'HLS not supported';
          em.style.cssText='color:red;text-align:center;padding:20px;';
          container.appendChild(em);
        }
      }

      return { container, video, hls:hlsInstance, animationFrameId };
    }

    /* Mobile pseudo-FS (no changes) */
    let pseudoFsCleanup = null;
    function enterPseudoFullscreen(container, video){
      if (document.querySelector('.player-fullscreen-mobile')) return;
      const htmlEl = document.documentElement;
      const isMp4 = container.classList.contains('mp4-player');
      htmlEl.classList.add("pseudo-fullscreen-mobile");
      if (!IS_SAFARI_MOBILE) htmlEl.classList.add("non-safari");
      container.classList.add("player-fullscreen-mobile");
      if (video.paused) video.play().catch(()=>{});

      let controlsCleanup=null, gestureCleanup=null;
      if (!isMp4){
        const ctrls = setupMobileFullscreenControls(container, video);
        const gests = setupPseudoFullscreenGestures(container, video, ctrls.showFsControls, ctrls.hideFsControls);
        controlsCleanup = ctrls.cleanup;
        gestureCleanup  = gests.cleanup;
        if (players[container.dataset.url]){
          players[container.dataset.url].controlsApi = {
            showFsControls: ctrls.showFsControls,
            hideFsControls: ctrls.hideFsControls
          };
        }
      } else {
        video.controls = true;
      }

      pseudoFsCleanup = ()=>{
        if (controlsCleanup) controlsCleanup();
        if (gestureCleanup) gestureCleanup();
        if (players[container.dataset.url]) delete players[container.dataset.url].controlsApi;
      };

      if (!IS_SAFARI_MOBILE) hideBrowserUI();
    }
    function exitPseudoFullscreen(container, video){
      if (!container || !container.classList.contains('player-fullscreen-mobile')) return;
      if (pseudoFsCleanup){ pseudoFsCleanup(); pseudoFsCleanup=null; }
      const htmlEl = document.documentElement;
      const isMp4 = container.classList.contains('mp4-player');
      htmlEl.classList.remove("pseudo-fullscreen-mobile","non-safari");
      container.classList.remove("player-fullscreen-mobile","controls-open");
      if (!isMp4){
        video.style.transform = 'scale(1) translate(0,0)';
        video.style.transformOrigin = 'center center';
      } else {
        video.controls = true;
      }
      const fsCtrls = container.querySelector('.fullscreen-controls');
      if (fsCtrls) fsCtrls.remove();
      document.body.style.height='';
      document.body.style.overflow='';
      document.body.style.position='';
      htmlEl.style.height='';
      htmlEl.style.overflow='';
      htmlEl.style.minHeight='';
    }

    /* Mobile FS controls & gestures (no changes) */
    function setupMobileFullscreenControls(container, video){ /* ... */ }
    function setupPseudoFullscreenGestures(container, video, showFsControls, hideFsControls){ /* ... */ }

    /* Modal logic (no changes) */
    function openUrlModal(){ /* ... */ }
    function closeUrlModal(){ /* ... */ }
    function saveUrlsAndClose(){ /* ... */ }

    /* Initialization */
    function initializeApp(){
      updateStreamSidebar();
      const streams = getStreamList();
      streams.forEach(s=>{
        if (s.enabled){
          const p = createPlayerContainer(s);
          if (p){
            mainContent.appendChild(p.container);
            players[s.url] = p;
          }
        }
      });
      reorderPlayers();

      btnShowAll.addEventListener("click",()=>{ getStreamList().forEach(s=>{ if (!s.enabled) updateStreamEnabled(s.url,true); }); });
      btnHideAll.addEventListener("click",()=>{ getStreamList().forEach(s=>{ if (s.enabled) updateStreamEnabled(s.url,false); }); });

      btnAddUrls.addEventListener("click",openUrlModal);
      modalBackdrop.addEventListener("click",closeUrlModal);
      saveUrlsBtn.addEventListener("click",saveUrlsAndClose);

      window.addEventListener("keydown", e=>{
        if (e.key==="Escape"){
          if (urlModal.style.display==="block") closeUrlModal();
          else if (document.querySelector('.player-fullscreen-mobile')){
            const fs = document.querySelector('.player-fullscreen-mobile');
            if (fs && players[fs.dataset.url]) exitPseudoFullscreen(fs,players[fs.dataset.url].video);
          } else if (document.fullscreenElement||document.webkitFullscreenElement){
            exitNativeFullScreen();
          }
        }
      });

      if (IS_MOBILE){
        sidebar.classList.add("hidden");
        sidebarToggle.style.display="block";
        let touchStartX=null;
        const swipeThreshold=50;
        sidebar.addEventListener("touchstart",e=>{ touchStartX=e.changedTouches[0].screenX; },{passive:true});
        sidebar.addEventListener("touchend",e=>{
          if (touchStartX===null) return;
          const deltaX = touchStartX - e.changedTouches[0].screenX;
          if (deltaX>swipeThreshold){
            sidebar.classList.add("hidden");
            sidebarToggle.style.display="block";
          }
          touchStartX=null;
        });
        sidebarToggle.addEventListener("click",()=>{
          sidebar.classList.remove("hidden");
          sidebarToggle.style.display="none";
        });
        mainContent.addEventListener("touchstart",e=>{
          if (!sidebar.classList.contains("hidden") && !e.target.closest('button,input[type="range"],.progress-bar')){
            sidebar.classList.add("hidden");
            sidebarToggle.style.display="block";
          }
        },{passive:true});
      }
    }
    if (document.readyState==='loading') document.addEventListener('DOMContentLoaded',initializeApp);
    else initializeApp();
  </script>
</body>
</html>