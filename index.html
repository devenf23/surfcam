<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Live DVR – Desktop & Mobile</title>
  <style>
    /* ---------- GENERAL ---------- */
    html, body { margin:0; padding:0; height:100vh; font-family:Arial,sans-serif; background:#222; color:#fff; overflow:hidden; }
    .container { display:flex; height:100vh; }

    /* ---------- SIDEBAR ---------- */
    #sidebar { background:#444; width:220px; padding:20px; box-sizing:border-box; overflow-y:auto; transition:transform .3s ease; }
    #sidebar.hidden { transform:translateX(-100%); }
    #btn-add-urls, .sideBtn, #urlModal button { width:100%; padding:10px; margin-bottom:10px; font-size:16px; cursor:pointer; }
    #sideButtons { display:flex; gap:10px; }
    .sideBtn { flex:1; }
    #streamList { margin-top:10px; line-height:1.2; }
    .no-streams { font-style:italic; color:#bbb; }
    .stream-item { display:flex; align-items:center; margin-bottom:5px; }
    .stream-item label { margin-left:5px; cursor:pointer; user-select:none; }

    /* ---------- MAIN CONTENT ---------- */
    #main-content { flex:1; background:#333; padding:20px; box-sizing:border-box; display:flex; flex-wrap:wrap; gap:20px; overflow:auto; }
    html.mobile #main-content { flex-direction:column; align-items:center; flex-wrap:nowrap; margin-left:0; }

    /* ---------- PLAYER CONTAINERS ---------- */
    .player-container { background:#222; display:flex; flex-direction:column; position:relative; box-sizing:border-box; }
    .player-container.desktop { width:960px; height:600px; margin-bottom:40px; }
    .player-container.mobile { width:240px; margin:0 auto 20px; display:flex; flex-direction:column; background:#222; box-sizing:border-box; }

    /* --------- VIDEO & CANVAS --------- */
    .canvas-wrapper { position:relative; width:960px; height:540px; overflow:hidden; }
    .canvas-wrapper canvas { position:absolute; top:0; left:0; width:100%; height:100%; }
    /* Fullscreen expands wrapper by CSS only */
    .player-container:fullscreen .canvas-wrapper,
    .player-container:-webkit-full-screen .canvas-wrapper {
      width:100%!important; height:100%!important;
    }
    .player-container:fullscreen .canvas-wrapper canvas,
    .player-container:-webkit-full-screen .canvas-wrapper canvas {
      width:100%!important; height:100%!important;
    }
    .player-container.desktop .source-video { opacity:0; position:absolute; top:0; left:0; width:960px; height:540px; pointer-events:none; }
    .player-container.mobile .source-video { width:240px; height:135px; }
    .player-container.mobile .display-canvas { display:none; }

    /* ------ CONTROLS & OVERLAYS ------ */
    .controls-container { position:relative; z-index:2; }
    .control-bar { display:flex; align-items:center; gap:10px; background:rgba(0,0,0,0.75); padding:5px 10px; }
    .control-bar button { padding:4px 8px; cursor:pointer; }

    /* Custom progress bar */
    .progress-bar { position:relative; flex:1 1 0; height:6px; background:#fff; border-radius:6px; overflow:visible; margin:0 5px; cursor:pointer; }
    .progress-bar .buffered,
    .progress-bar .played {
      position:absolute; top:0; bottom:0; left:0; border-radius:6px;
    }
    .progress-bar .buffered { background:#888; width:0%; }
    .progress-bar .played   { background:#4d90fe; width:0%; }
    .progress-bar .thumb {
      position:absolute; top:50%; left:0; width:12px; height:12px;
      background:#fff; border-radius:50%; transform:translate(-50%,-50%); cursor:pointer;
    }

    .disable-btn { background:red; color:#fff; border:none; }
    .title-bar { text-align:center; background:rgba(0,0,0,0.75); padding:2px 10px; font-size:16px; }
    .overlay-controls { position:absolute; bottom:0; left:0; right:0; }
    .mobile-play-overlay {
      position:absolute; top:0; left:0; width:100%; height:100%;
      background:rgba(0,0,0,0.6); display:flex; align-items:center; justify-content:center;
      color:#fff; font-size:24px; z-index:10;
    }

    /* ------- URL MODAL & BACKDROP ------- */
    #modalBackdrop { display:none; position:fixed; z-index:5; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); }
    #urlModal {
      display:none; position:fixed; z-index:10;
      left:50%; top:50%; transform:translate(-50%,-50%);
      width:1200px; background:#555; border:2px solid #fff; padding:15px; box-sizing:border-box;
    }
    #urlModal textarea { width:100%; height:600px; padding:10px; font-size:14px; box-sizing:border-box; }

    /* ----- MOBILE SIDEBAR ----- */
    html.mobile #urlModal   { width:300px; padding:4px; font-size:12px; }
    html.mobile #urlModal textarea { height:150px; padding:5px; font-size:12px; }
    html.mobile #sidebar { position:fixed; top:0; left:0; height:100%; z-index:1000; }
    #sidebarToggle { display:none; }
    html.mobile #sidebarToggle {
      display:block; position:fixed; top:50%; left:0; transform:translate(-50%,-50%);
      z-index:1100; background:#444; border:none; padding:10px 12px;
      font-size:24px; color:#fff; cursor:pointer;
    }

    /* ——— MOBILE FULLSCREEN & PINCH‑ZOOM ——— */
    html.mobile .player-container.mobile.fullscreen-mobile {
      position:fixed; top:0; left:0; width:100vw; height:100vh;
      margin:0; z-index:1001; background:#000;
    }
    html.mobile .player-container.mobile.fullscreen-mobile video {
      width:100%; height:100%; object-fit:contain;
      transform-origin:center center;
    }
    html.mobile .mobile-controls {
      position:absolute; bottom:0; left:0; width:100%;
      background:rgba(0,0,0,0.7); display:flex; align-items:center;
      padding:10px; box-sizing:border-box; z-index:1002;
    }
    html.mobile .mobile-controls button {
      padding:8px 12px; margin-right:10px; font-size:16px; cursor:pointer;
    }
    html.mobile .mobile-controls input[type="range"] { flex:1; margin:0; }
  </style>
  <script>
    if(/Mobi|Android|iPhone|iPad/i.test(navigator.userAgent))
      document.documentElement.classList.add("mobile");

    let spaceHeld=false;
    window.addEventListener("keydown",e=>{
      if(e.code==="Space" && !["input","textarea","button"]
         .includes(document.activeElement.tagName.toLowerCase())){
        e.preventDefault(); spaceHeld=true;
      }
    });
    window.addEventListener("keyup",e=>{ if(e.code==="Space") spaceHeld=false; });

    let cursorTimeout;
    function showCursor(){ document.body.style.cursor=""; }
    function hideCursor(){ document.body.style.cursor="none"; }
    document.addEventListener("fullscreenchange",()=>{
      if(document.fullscreenElement){
        showCursor(); clearTimeout(cursorTimeout);
        cursorTimeout=setTimeout(hideCursor,2000);
      } else {
        showCursor(); clearTimeout(cursorTimeout);
      }
    });
    document.addEventListener("mousemove",()=>{
      if(document.fullscreenElement){
        showCursor(); clearTimeout(cursorTimeout);
        cursorTimeout=setTimeout(hideCursor,2000);
      }
    });
  </script>
</head>
<body>
  <button id="sidebarToggle">&#x25B6;</button>
  <div class="container">
    <div id="sidebar">
      <button id="btn-add-urls">Add URLs</button>
      <div id="sideButtons">
        <button id="btn-show-all" class="sideBtn">Show All</button>
        <button id="btn-hide-all" class="sideBtn">Hide All</button>
      </div>
      <div id="streamList"></div>
    </div>
    <div id="main-content"></div>
  </div>
  <div id="modalBackdrop"></div>
  <div id="urlModal">
    <h3 style="margin-top:0; text-align:center;">Paste Playlist URLs (one per line)</h3>
    <textarea id="urlInput" placeholder="https://…/playlist.m3u8"></textarea>
    <button id="saveUrls">Save and Close</button>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/hls.js@0.14.16"></script>
  <script>
    function enterFullScreen(el){
      const r=el.requestFullscreen||el.webkitRequestFullscreen||el.mozRequestFullScreen||el.msRequestFullscreen;
      if(r) return r.call(el);
    }
    function exitFullScreen(){
      const e=document.exitFullscreen||document.webkitExitFullscreen||document.mozCancelFullScreen||document.msExitFullscreen;
      if(e) return e.call(document);
    }

    const PROXY_PREFIX="https://surfcam-alpha.vercel.app/api/proxy?url=";
    function loadPlayerSettings(u){
      try{ return JSON.parse(localStorage.playerSettings||"{}")[u]||{zoomScale:1,panX:0,panY:0}; }
      catch{ return{zoomScale:1,panX:0,panY:0}; }
    }
    function savePlayerSettings(u,d){
      let o={}; try{o=JSON.parse(localStorage.playerSettings||"{}");}catch{}
      o[u]=d; localStorage.playerSettings=JSON.stringify(o);
    }
    function clampPan(c){
      const Z=c.zoomScale, W=960, H=540;
      if(Z<=1){ c.panX=0; c.panY=0; return; }
      const mx=(W*(Z-1))/(2*Z), my=(H*(Z-1))/(2*Z);
      c.panX=Math.min(mx,Math.max(-mx,c.panX));
      c.panY=Math.min(my,Math.max(-my,c.panY));
    }

    (function(){
      const storageKey="streamConfigs", activeLabels=new Set();

      function getStreamList(){
        try{ return JSON.parse(localStorage[storageKey]||"[]"); }catch{return[];}
      }
      function saveStreamList(l){ localStorage[storageKey]=JSON.stringify(l); }
      function extractTitle(u){ const m=u.match(/wc-([^\/]+)\/playlist/); return m?m[1]:u; }

      // ... sidebar + update logic unchanged ...

      function createPlayerContainer(stream){
        if(!stream.enabled) return null;
        const url=stream.url,
              isMobile=document.documentElement.classList.contains("mobile"),
              saved=loadPlayerSettings(url);

        const container=document.createElement("div");
        container.className="player-container "+(isMobile?"mobile":"desktop");
        container.dataset.url=url;
        container.zoomScale=saved.zoomScale;
        container.panX=saved.panX;
        container.panY=saved.panY;

        const video=document.createElement("video");
        video.className="source-video";
        ["playsinline","webkit-playsinline","crossorigin"].forEach(a=>video.setAttribute(a,""));
        video.muted=true;
        video.preload="auto";
        if(isMobile){
          // disable native controls → use custom controls
          video.controls=false;
          video.src=PROXY_PREFIX+encodeURIComponent(url);
        } else {
          video.autoplay=true;
        }
        container.appendChild(video);

        if(isMobile){
          // Tap‐to‐Start Overlay
          const overlay=document.createElement("div");
          overlay.className="mobile-play-overlay";
          overlay.innerText="Tap to Start";
          container.appendChild(overlay);

          // Custom mobile controls (hidden until tapped)
          const controls=document.createElement("div");
          controls.className="mobile-controls";
          controls.style.display="none";

          // Play/Pause button
          const playBtn=document.createElement("button");
          playBtn.textContent="Play";
          playBtn.addEventListener("click",()=>{
            if(video.paused) video.play();
            else video.pause();
          });
          video.addEventListener("play",()=>playBtn.textContent="Pause");
          video.addEventListener("pause",()=>playBtn.textContent="Play");
          controls.appendChild(playBtn);

          // Scrub bar
          const scrubBar=document.createElement("input");
          scrubBar.type="range"; scrubBar.min=0; scrubBar.step=0.1; scrubBar.value=0;
          let scrubDragging=false;
          scrubBar.addEventListener("mousedown",()=>scrubDragging=true);
          scrubBar.addEventListener("mouseup",()=>scrubDragging=false);
          scrubBar.addEventListener("input",()=>video.currentTime=parseFloat(scrubBar.value));
          video.addEventListener("loadedmetadata",()=>{ scrubBar.max=video.duration||0; });
          video.addEventListener("timeupdate",()=>{ if(!scrubDragging) scrubBar.value=video.currentTime; });
          controls.appendChild(scrubBar);

          container.appendChild(controls);

          // On first tap: start load/play, enter “fullscreen‐mobile”, show controls
          overlay.addEventListener("click",()=>{
            if(container.hls) container.hls.startLoad();
            video.play().catch(()=>{});
            overlay.style.display="none";
            container.classList.add("fullscreen-mobile");
            controls.style.display="flex";
          });

          // Pinch‐to‐zoom implementation
          let initialDist=null;
          container.currentScale=1;
          container.tempScale=null;
          container.addEventListener("touchstart",e=>{
            if(e.touches.length===2){
              const dx=e.touches[0].pageX - e.touches[1].pageX;
              const dy=e.touches[0].pageY - e.touches[1].pageY;
              initialDist=Math.hypot(dx,dy);
              container.tempScale=null;
            }
          },{passive:true});
          container.addEventListener("touchmove",e=>{
            if(e.touches.length===2 && initialDist){
              e.preventDefault();
              const dx=e.touches[0].pageX - e.touches[1].pageX;
              const dy=e.touches[0].pageY - e.touches[1].pageY;
              const dist=Math.hypot(dx,dy);
              let scale=container.currentScale*(dist/initialDist);
              scale=Math.max(1,Math.min(3,scale));
              video.style.transform=`scale(${scale})`;
              container.tempScale=scale;
            }
          },{passive:false});
          container.addEventListener("touchend",e=>{
            if(initialDist && container.tempScale){
              container.currentScale=container.tempScale;
            }
            if(e.touches.length<2){
              initialDist=null;
            }
          });

        } else {
          // ——— desktop rendering & controls unchanged ———
          const wrapper=document.createElement("div"); wrapper.className="canvas-wrapper";
          container.appendChild(wrapper);
          const canvas=document.createElement("canvas"); canvas.className="display-canvas";
          canvas.width=960; canvas.height=540;
          wrapper.appendChild(canvas);
          const ctx=canvas.getContext("2d");
          (function render(){
            if(video.readyState>=2){
              clampPan(container);
              ctx.save();
              ctx.clearRect(0,0,960,540);
              const cx=480, cy=270;
              ctx.translate(cx,cy);
              ctx.scale(container.zoomScale,container.zoomScale);
              ctx.translate(container.panX,container.panY);
              ctx.translate(-cx,-cy);
              try{ctx.drawImage(video,0,0,960,540);}catch{}
              ctx.restore();
            }
            requestAnimationFrame(render);
          })();
          // … desktop mouse/keyboard zoom & pan, controls, Hls hookup, etc. remain exactly as before …
        }

        // Hls.js or native playback initialization (unchanged)
        const canNative=video.canPlayType("application/vnd.apple.mpegurl");
        if(Hls.isSupported()&&!canNative){
          const hls=new Hls({
            maxBufferLength:120, maxBufferSize:60*1024*1024,
            liveSyncDurationCount:3, manifestLoadingTimeOut:30000,
            levelLoadingTimeOut:30000,
            loader: class extends Hls.DefaultConfig.loader {
              load(ctx,cfg,cb){
                let u=ctx.url;
                while(u.startsWith(PROXY_PREFIX)) u=decodeURIComponent(u.slice(PROXY_PREFIX.length));
                ctx.url=PROXY_PREFIX+encodeURIComponent(u);
                super.load(ctx,cfg,cb);
              }
            }
          });
          hls.attachMedia(video);
          hls.on(Hls.Events.MANIFEST_PARSED,()=>video.play().catch(()=>{}));
          hls.loadSource(url);
          hls.on(Hls.Events.ERROR,(_,d)=>{
            if(d.fatal){
              switch(d.type){
                case Hls.ErrorTypes.NETWORK_ERROR: hls.startLoad(); break;
                case Hls.ErrorTypes.MEDIA_ERROR:   hls.recoverMediaError(); break;
                default:                            hls.destroy(); break;
              }
            }
          });
          container.hls=hls;
        } else if(canNative){
          video.src=PROXY_PREFIX+encodeURIComponent(url);
          if(!isMobile) video.play().catch(()=>{});
        }

        // Double‐tap/dblclick to fullscreen (desktop only in practice)
        container.addEventListener("dblclick",()=>{
          if(!document.fullscreenElement) enterFullScreen(container);
          else exitFullScreen();
        });

        return container;
      }

      // … rest of initialization, sidebar buttons, modal logic, mobile‑sidebar toggles, etc. unchanged …

      updateStreamSidebar();
      getStreamList().forEach(s=>{ if(s.enabled) updateStreamEnabled(s.url,true); });
    })();
  </script>
</body>
</html>