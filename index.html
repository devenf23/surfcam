<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>Live DVR – Desktop & Mobile</title>
  <style>
    /* ---------- GENERAL ---------- */
    html, body {
      margin: 0; padding: 0; height: 100vh; font-family: Arial, sans-serif;
      background: #222; color: #fff; overflow: hidden;
      position: fixed; width: 100%;
    }
    .container {
      display: flex; height: 100vh; width: 100%;
    }

    /* ---------- SIDEBAR ---------- */
    #sidebar {
      background: #444; width: 220px; padding: 20px;
      box-sizing: border-box; overflow-y: auto;
      transition: transform .3s ease; flex-shrink: 0; z-index: 1000;
      -webkit-overflow-scrolling: touch;
    }
    #sidebar.hidden { transform: translateX(-100%); }
    #btn-add-urls, .sideBtn, #urlModal button {
      width: 100%; padding: 10px; margin-bottom: 10px;
      font-size: 16px; cursor: pointer; border-radius: 8px;
      border: 1px solid #666; background-color: #555; color: #fff;
    }
    #btn-add-urls:hover, .sideBtn:hover, #urlModal button:hover {
      background-color: #666;
    }
    #sideButtons { display: flex; gap: 10px; }
    .sideBtn { flex: 1; }
    #streamList { margin-top: 10px; line-height: 1.2; }
    .no-streams { font-style: italic; color: #bbb; }
    .stream-item {
      display: flex; align-items: center; margin-bottom: 5px;
      padding: 5px; border-radius: 4px; transition: background-color 0.2s;
    }
    .stream-item.selecting { background-color: #666; }
    .stream-item:hover { background-color: #555; }
    .stream-item label {
      margin-left: 8px; cursor: pointer; user-select: none; flex-grow: 1;
    }
    .stream-item input[type="checkbox"] {
      cursor: pointer; width: 18px; height: 18px; flex-shrink: 0;
    }

    /* ---------- MAIN CONTENT ---------- */
    #main-content {
      flex: 1; background: #333; padding: 20px; box-sizing: border-box;
      display: flex; flex-wrap: wrap; gap: 20px; overflow: auto;
      border-radius: 8px 0 0 8px; height: 100vh;
      -webkit-overflow-scrolling: touch; align-content: flex-start;
    }
    html.mobile #main-content {
      flex-direction: column; align-items: center; flex-wrap: nowrap;
      margin-left: 0; border-radius: 0; padding-top: 60px;
      height: 100vh; overflow-y: scroll;
    }

    /* ---------- PLAYER CONTAINERS ---------- */
    .player-container {
      background: #222; display: flex; flex-direction: column;
      position: relative; box-sizing: border-box; border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3); flex-shrink: 0;
    }
    .player-container.desktop {
      width: 960px; max-width: 100%; margin-bottom: 20px;
    }
    .player-container.mobile {
      margin: 0 auto 20px; width: calc(100% - 40px);
      max-width: 480px; border-radius: 12px; overflow: hidden;
    }

    /* --------- VIDEO & CANVAS --------- */
    .canvas-wrapper {
      position: relative; width: 100%; aspect-ratio: 16/9;
      overflow: hidden; border-radius: 12px 12px 0 0; background: #000;
    }
    .canvas-wrapper canvas {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      display: block;
    }
    /* Native Fullscreen */
    .player-container:fullscreen,
    .player-container:-webkit-full-screen {
      width: 100% !important; height: 100% !important; max-width: none !important;
      border-radius: 0 !important; box-shadow: none !important;
      z-index: 2147483647; background: #000;
      display: flex; flex-direction: column;
      justify-content: center; align-items: center; overflow: hidden;
    }
    .player-container:fullscreen .canvas-wrapper,
    .player-container:-webkit-full-screen .canvas-wrapper {
      width: 100% !important; height: auto !important;
      max-height: calc(100vh - 60px); aspect-ratio: 16/9;
      border-radius: 0; position: relative; flex-shrink: 1;
    }
    .player-container:fullscreen .canvas-wrapper canvas,
    .player-container:-webkit-full-screen .canvas-wrapper canvas {
      width: 100% !important; height: 100% !important;
    }
    .player-container.desktop .source-video {
      opacity: 0; position: absolute; top: -9999px; left: -9999px;
      width: 1px; height: 1px; pointer-events: none;
    }
    .player-container.mobile .source-video {
      width: 100%; height: auto; display: block;
      border-radius: 12px 12px 0 0; background: #000;
    }
    .player-container.mobile .display-canvas { display: none; }

    /* ------ CONTROLS & OVERLAYS ------ */
    .controls-container {
      position: relative; z-index: 2; background: #222;
      border-radius: 0 0 12px 12px;
    }
    .control-bar {
      display: flex; align-items: center; gap: 10px;
      padding: 8px 12px;
    }
    .control-bar button {
      padding: 6px 10px; cursor: pointer; background: #555; border: none;
      color: #fff; border-radius: 6px; font-size: 14px;
      transition: background-color 0.2s; flex-shrink: 0;
    }
    .control-bar button:hover { background: #666; }
    .progress-bar {
      position: relative; flex: 1 1 auto; height: 8px; background: #555;
      border-radius: 8px; overflow: visible; margin: 0 10px; cursor: pointer;
      min-width: 50px;
    }
    .progress-bar .buffered,
    .progress-bar .played {
      position: absolute; top: 0; bottom: 0; left: 0;
      border-radius: 8px; pointer-events: none;
    }
    .progress-bar .buffered { background: #888; opacity: 0.7; width: 0%; }
    .progress-bar .played { background: #4d90fe; z-index: 1; width: 0%; }
    .progress-bar .thumb {
      position: absolute; top: 50%; left: 0; width: 14px; height: 14px;
      background: #fff; border-radius: 50%;
      transform: translate(-50%,-50%); cursor: pointer; z-index: 2;
      box-shadow: 0 0 5px rgba(0,0,0,0.5);
      transition: transform 0.1s ease;
    }
    .progress-bar:hover .thumb {
      transform: translate(-50%,-50%) scale(1.1);
    }
    .disable-btn { background: #e74c3c; color: #fff; border: none; }
    .disable-btn:hover { background: #c0392b; }
    .title-bar {
      text-align: center; padding: 5px 10px; font-size: 14px;
      color: #eee; background: rgba(0,0,0,0.75);
      white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
      border-radius: 0 0 12px 12px;
    }
    .control-bar + .title-bar {
      border-radius: 0; border-top: 1px solid #444;
    }

    /* ------- URL MODAL & BACKDROP ------- */
    #modalBackdrop {
      display: none; position: fixed; z-index: 1005;
      top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.7);
    }
    #urlModal {
      display: none; position: fixed; z-index: 1010;
      left: 50%; top: 50%; transform: translate(-50%,-50%);
      width: 90%; max-width: 1200px; background: #555;
      padding: 25px; box-sizing: border-box; border-radius: 12px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.5);
    }
    #urlModal h3 {
      margin-top: 0; text-align: center; color: #fff;
      margin-bottom: 15px;
    }
    #urlModal textarea {
      width: 100%; height: 400px; padding: 15px; font-size: 14px;
      box-sizing: border-box; border-radius: 8px; border: 1px solid #666;
      background: #f8f8f8; color: #333; margin-bottom: 15px;
      resize: vertical; -webkit-overflow-scrolling: touch;
    }
    #urlModal button {
      width: auto; padding: 12px 25px; font-size: 16px;
      display: block; margin: 0 auto;
    }

    /* ----- MOBILE SIDEBAR ----- */
    html.mobile #urlModal {
      width: 90vw; max-width: 400px; padding: 15px; font-size: 14px;
    }
    html.mobile #urlModal textarea {
      height: 200px; padding: 10px; font-size: 14px;
    }
    html.mobile #sidebar {
      position: fixed; top: 0; left: 0; height: 100%;
      border-radius: 0 8px 8px 0; box-shadow: 3px 0 10px rgba(0,0,0,0.3);
    }
    #sidebarToggle {
      display: none; position: fixed; top: 20px; left: 10px;
      z-index: 1100; background: #444; border: none;
      width: 40px; height: 40px; font-size: 20px;
      line-height: 40px; text-align: center; color: #fff;
      cursor: pointer; border-radius: 50%; box-shadow: 0 2px 5px rgba(0,0,0,0.3);
    }

    /* ----- MOBILE ROOT SCROLL OVERRIDE ----- */
    html.mobile .container {
      height: 100vh !important;
    }

    /* ------ MOBILE NON-FULLSCREEN PLAYER ------ */
    html.mobile .player-container.mobile:not(.player-fullscreen-mobile) .canvas-wrapper,
    html.mobile .player-container.mobile:not(.player-fullscreen-mobile) .display-canvas {
      display: none !important;
    }
    html.mobile .player-container.mobile:not(.player-fullscreen-mobile) .controls-container {
      display: block !important; position: relative;
      background: #222; border-radius: 0 0 12px 12px; padding: 0;
    }
    html.mobile .player-container.mobile:not(.player-fullscreen-mobile) .progress-bar,
    html.mobile .player-container.mobile:not(.player-fullscreen-mobile) .reset-btn,
    html.mobile .player-container.mobile:not(.player-fullscreen-mobile) .disable-btn {
      display: none !important;
    }
    html.mobile .player-container.mobile:not(.player-fullscreen-mobile) .control-bar {
      justify-content: space-between; padding: 8px 12px; background: none;
    }
    html.mobile .player-container.mobile:not(.player-fullscreen-mobile) .fs-btn-mobile {
      display: inline-block;
    }

    .video-title-row {
      display: flex; align-items: center; justify-content: space-between;
      padding: 8px 12px; background: rgba(0,0,0,0.6);
      color: #eee; font-size: 14px; border-bottom: 1px solid #444;
    }
    .fs-btn-mobile {
      cursor: pointer; background: none; color: #fff; border: none;
      padding: 4px 8px; font-size: 20px; line-height: 1; flex-shrink: 0;
    }
    .video-title-row span {
      flex-grow: 1; text-align: center; margin: 0 10px;
      white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    }

    /* ---------- MOBILE PSEUDO-FULLSCREEN ---------- */
    html.pseudo-fullscreen-mobile {
      position: relative; overflow: hidden !important; height: 100vh !important;
    }
    html.pseudo-fullscreen-mobile.non-safari {
      overflow-y: scroll !important; height: auto !important;
      min-height: 105vh;
    }
    html.pseudo-fullscreen-mobile body {
      overflow: visible !important; height: auto !important;
      position: static !important; min-height: 105vh;
    }
    html.pseudo-fullscreen-mobile .container {
      height: auto !important; min-height: 105vh;
      position: static !important; display: block !important;
    }
    html.pseudo-fullscreen-mobile #main-content {
      height: auto !important; min-height: 105vh;
      display: block !important;
    }
    .player-container.player-fullscreen-mobile {
      position: fixed !important; top: 0; left: 0;
      width: 100vw !important; height: 100vh !important;
      max-width: none !important; margin: 0 !important;
      border-radius: 0 !important; background: #000 !important;
      z-index: 2000 !important; overflow: hidden;
    }
    .player-container.player-fullscreen-mobile .source-video {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      object-fit: contain; border-radius: 0;
      transform-origin: center center;
      transform: scale(1) translate(0px, 0px);
      cursor: grab; will-change: transform;
    }
    .player-container.player-fullscreen-mobile .source-video:active {
      cursor: grabbing;
    }
    .player-container.player-fullscreen-mobile .video-title-row,
    .player-container.player-fullscreen-mobile .controls-container:not(.fullscreen-controls) {
      display: none !important;
    }
    .player-container.player-fullscreen-mobile .fullscreen-controls {
      display: block !important;
    }

    /* Mobile Fullscreen Controls */
    .fullscreen-controls {
      display: none; position: absolute; bottom: -120px;
      left: 50%; transform: translateX(-50%);
      width: 90%; max-width: 500px; z-index: 2100;
      transition: bottom 0.3s ease-in-out;
      border-radius: 10px; background: rgba(0,0,0,0.8);
      box-sizing: border-box; padding-bottom: env(safe-area-inset-bottom, 10px);
    }
    .player-container.controls-open .fullscreen-controls {
      bottom: 10px;
    }
    .fullscreen-controls .control-bar {
      padding: 10px 15px; gap: 15px;
    }
    .fullscreen-controls .progress-bar {
      display: flex !important;
    }

    /* PWA Standalone Adjustments */
    @media all and (display-mode: standalone) {
      html.mobile body {
        padding-top: env(safe-area-inset-top, 0px);
      }
      html.mobile #sidebarToggle {
        top: calc(20px + env(safe-area-inset-top, 0px));
      }
      html.mobile #main-content {
        padding-top: 60px;
        padding-bottom: env(safe-area-inset-bottom, 0px);
        height: calc(100vh - env(safe-area-inset-top, 0px));
        box-sizing: border-box;
      }
      .player-container.controls-open .fullscreen-controls {
        bottom: env(safe-area-inset-bottom, 10px);
      }
    }

    /* ------------ NEW: allow page scroll so mobile non-safari UI can hide --------- */
    html.non-safari-mobile:not(.pseudo-fullscreen-mobile),
    html.non-safari-mobile:not(.pseudo-fullscreen-mobile) body {
      position: static !important;
      height: auto !important;
      overflow: auto !important;
    }
    html.non-safari-mobile:not(.pseudo-fullscreen-mobile) .container,
    html.non-safari-mobile:not(.pseudo-fullscreen-mobile) #main-content {
      height: auto !important;
      min-height: 100vh !important;
    }
    html.non-safari-mobile:not(.pseudo-fullscreen-mobile) #main-content {
      overflow: visible !important;
    }
  </style>

  <script>
    // --- PWA Meta Tag Injection for Safari Mobile ---
    (function(){
      const ua = navigator.userAgent;
      const isSafariMobile = /iPhone|iPad|iPod/.test(ua)
        && /AppleWebKit/.test(ua)
        && !/CriOS/.test(ua)
        && !/FxiOS/.test(ua);
      if(isSafariMobile){
        const head = document.head;
        const metas = [
          {name:'apple-mobile-web-app-capable', content:'yes'},
          {name:'apple-mobile-web-app-status-bar-style', content:'black-translucent'},
          {name:'apple-mobile-web-app-title', content:'Live DVR'}
        ];
        metas.forEach(m=>{
          const tag = document.createElement('meta');
          tag.name = m.name;
          tag.content = m.content;
          head.appendChild(tag);
        });
        console.log("Safari Mobile detected: Added PWA meta tags.");
      }
    })();

    // --- Global Flags & Detection ---
    const IS_MOBILE = /Mobi|Android|iPhone|iPad/i.test(navigator.userAgent);
    const IS_SAFARI_MOBILE = IS_MOBILE
      && /iPhone|iPad|iPod/.test(navigator.userAgent)
      && /AppleWebKit/.test(navigator.userAgent)
      && !/CriOS/.test(navigator.userAgent)
      && !/FxiOS/.test(navigator.userAgent);
    if(IS_MOBILE){
      document.documentElement.classList.add("mobile");
      if(IS_SAFARI_MOBILE) document.documentElement.classList.add("safari-mobile");
      else document.documentElement.classList.add("non-safari-mobile");
    }

    // Spacebar handling (desktop)
    let spaceHeld = false;
    window.addEventListener("keydown", e => {
      if(e.code==="Space"
        && !["input","textarea","button"].includes(document.activeElement.tagName.toLowerCase())
      ){
        e.preventDefault();
        spaceHeld = true;
      }
    });
    window.addEventListener("keyup", e => {
      if(e.code==="Space") spaceHeld = false;
    });

    // Cursor auto-hide (desktop native fullscreen)
    let cursorTimeout;
    function showCursor(){ document.body.style.cursor = ""; }
    function hideCursor(){ document.body.style.cursor = "none"; }
    document.addEventListener("fullscreenchange", ()=>{
      if(document.fullscreenElement){
        showCursor();
        clearTimeout(cursorTimeout);
        cursorTimeout = setTimeout(hideCursor, 3000);
      } else {
        showCursor();
        clearTimeout(cursorTimeout);
      }
    });
    document.addEventListener("mousemove", ()=>{
      if(document.fullscreenElement){
        showCursor();
        clearTimeout(cursorTimeout);
        cursorTimeout = setTimeout(hideCursor, 3000);
      }
    });

    // Helper to hide browser UI (non-Safari mobile)
    function hideBrowserUI(){
      if(!window.matchMedia('(display-mode: standalone)').matches && !IS_SAFARI_MOBILE){
        console.log("Attempting to hide browser UI (scrolling trick)...");
        setTimeout(()=>{
          const htmlScrollable = document.documentElement.scrollHeight > document.documentElement.clientHeight;
          console.log(`ScrollTop Before: window=${window.scrollY}, html=${document.documentElement.scrollTop}, htmlScrollable=${htmlScrollable}`);
          if(htmlScrollable){
            document.documentElement.scrollTop = 1;
          } else {
            window.scrollTo(0,1);
          }
          setTimeout(()=>{
            console.log(`ScrollTop After: window=${window.scrollY}, html=${document.documentElement.scrollTop}`);
          },100);
        },300);
      } else {
        console.log("Browser UI hiding skipped (PWA standalone or Safari).");
      }
    }
  </script>
</head>
<body>
  <button id="sidebarToggle">&#x2630;</button>
  <div class="container">
    <div id="sidebar">
      <!-- sidebar markup unchanged -->
      <button id="btn-add-urls">Add URLs</button>
      <div id="sideButtons">
        <button id="btn-show-all" class="sideBtn">Show All</button>
        <button id="btn-hide-all" class="sideBtn">Hide All</button>
      </div>
      <div id="streamList">
        <p class="no-streams">Loading streams...</p>
      </div>
    </div>
    <div id="main-content"></div>
  </div>
  <div id="modalBackdrop"></div>
  <div id="urlModal">
    <h3>Paste Playlist URLs (one per line)</h3>
    <textarea id="urlInput" placeholder="https://…/playlist.m3u8"></textarea>
    <button id="saveUrls">Save and Close</button>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  <script>
    // --- Fullscreen API, Storage Helpers, Stream & Player Logic, etc. (unchanged) ---
    // --- Player Creation, Controls, HLS.js setup (unchanged) ---

    // --- Mobile Pseudo-Fullscreen Gestures Setup ---
    function setupPseudoFullscreenGestures(container, video, showFsControls, hideFsControls) {
      let initialDistance = null;
      let initialScale = 1;
      let currentScale = 1;
      let initialMidpoint = null;
      let initialLocalMidpoint = { x: 0, y: 0 };
      let lastTranslateX = 0;
      let lastTranslateY = 0;
      let currentTranslateX = 0;
      let currentTranslateY = 0;
      let touchStartY = null;
      let touchStartTime = null;
      let isSwipingY = false;
      let isGesturing = false;
      let isPanning = false;
      let panStartX = 0, panStartY = 0, panLastX = 0, panLastY = 0;
      const listeners = [];
      function addListener(el, type, handler, opts) {
        el.addEventListener(type, handler, opts);
        listeners.push({ el, type, handler, opts });
      }
      const controlsApi = (players[container.dataset.url] && players[container.dataset.url].controlsApi) || { showFsControls, hideFsControls };

      function applyTransform() {
        currentScale = Math.max(1, Math.min(currentScale, 5));
        const rect = video.getBoundingClientRect();
        const visW = Math.min(rect.width, rect.height * (video.videoWidth / video.videoHeight));
        const visH = Math.min(rect.height, rect.width * (video.videoHeight / video.videoWidth));
        const maxX = (visW * (currentScale - 1)) / 2;
        const maxY = (visH * (currentScale - 1)) / 2;
        currentTranslateX = Math.max(-maxX, Math.min(maxX, currentTranslateX));
        currentTranslateY = Math.max(-maxY, Math.min(maxY, currentTranslateY));
        video.style.transform = `translate(${currentTranslateX}px, ${currentTranslateY}px) scale(${currentScale})`;
      }

      function handleStart(e) {
        if (e.target.closest('.fullscreen-controls')) return;
        isGesturing = true;
        if (e.touches.length === 1 && currentScale > 1) {
          // One-finger pan
          isPanning = true;
          panStartX = e.touches[0].clientX;
          panStartY = e.touches[0].clientY;
          panLastX = currentTranslateX;
          panLastY = currentTranslateY;
        } else if (e.touches.length === 1) {
          // Vertical swipe to show/hide controls / exit
          touchStartY = e.touches[0].clientY;
          touchStartTime = Date.now();
          isSwipingY = false;
        } else if (e.touches.length === 2) {
          // Pinch start
          isPanning = false;
          const [t1, t2] = [e.touches[0], e.touches[1]];
          initialDistance = Math.hypot(t1.clientX - t2.clientX, t1.clientY - t2.clientY);
          initialScale = currentScale;
          lastTranslateX = currentTranslateX;
          lastTranslateY = currentTranslateY;
          initialMidpoint = {
            x: (t1.clientX + t2.clientX) / 2,
            y: (t1.clientY + t2.clientY) / 2
          };
          const rect = video.getBoundingClientRect();
          const centerX = rect.left + rect.width / 2;
          const centerY = rect.top + rect.height / 2;
          initialLocalMidpoint = {
            x: initialMidpoint.x - centerX,
            y: initialMidpoint.y - centerY
          };
        }
      }

      function handleMove(e) {
        if (!isGesturing || e.target.closest('.fullscreen-controls')) return;
        if (isPanning && e.touches.length === 1) {
          // Pan video
          const dx = e.touches[0].clientX - panStartX;
          const dy = e.touches[0].clientY - panStartY;
          currentTranslateX = panLastX + dx;
          currentTranslateY = panLastY + dy;
          applyTransform();
        } else if (e.touches.length === 1) {
          // Detect vertical swipe
          const deltaY = e.touches[0].clientY - touchStartY;
          const deltaT = Date.now() - touchStartTime;
          if (!isSwipingY && (Math.abs(deltaY) > 10 || deltaT > 100)) {
            isSwipingY = true;
          }
        } else if (e.touches.length === 2) {
          // Pinch zoom
          e.preventDefault();
          const [t1, t2] = [e.touches[0], e.touches[1]];
          const dist = Math.hypot(t1.clientX - t2.clientX, t1.clientY - t2.clientY);
          const factor = dist / initialDistance;
          currentScale = initialScale * factor;
          // Pivot around initialLocalMidpoint, blending from lastTranslate
          currentTranslateX = lastTranslateX + (initialLocalMidpoint.x - lastTranslateX) * (1 - factor);
          currentTranslateY = lastTranslateY + (initialLocalMidpoint.y - lastTranslateY) * (1 - factor);
          applyTransform();
        }
      }

      function handleEnd(e) {
        if (!isGesturing) return;
        if (e.touches.length < 2) {
          // End of pinch or single-finger end
          initialDistance = null;
          if (currentScale <= 1) {
            currentScale = 1;
            currentTranslateX = 0;
            currentTranslateY = 0;
            lastTranslateX = 0;
            lastTranslateY = 0;
          } else {
            lastTranslateX = currentTranslateX;
            lastTranslateY = currentTranslateY;
          }
          applyTransform();
        }
        if (e.touches.length === 0 && isSwipingY) {
          // Finish vertical swipe -> show/hide controls or exit
          const deltaY = e.changedTouches[0].clientY - touchStartY;
          const deltaT = Date.now() - touchStartTime;
          if (Math.abs(deltaY) > 50 && deltaT < 500) {
            const open = container.classList.contains('controls-open');
            if (deltaY < 0) {
              controlsApi.showFsControls && controlsApi.showFsControls();
            } else {
              if (open) controlsApi.hideFsControls && controlsApi.hideFsControls();
              else exitPseudoFullscreen(container, video);
            }
          }
        }
        if (e.touches.length === 0) {
          isGesturing = false;
          isSwipingY = false;
          isPanning = false;
        }
      }

      addListener(container, 'touchstart', handleStart, { passive: false });
      addListener(container, 'touchmove', handleMove, { passive: false });
      addListener(container, 'touchend', handleEnd);
      addListener(container, 'touchcancel', handleEnd);

      applyTransform();

      return {
        cleanup() {
          listeners.forEach(({ el, type, handler, opts }) =>
            el.removeEventListener(type, handler, opts)
          );
          video.style.transform = 'scale(1) translate(0,0)';
          video.style.transformOrigin = 'center center';
        }
      };
    }

    // --- Initialization and Global Listeners ---
    function initializeApp() {
      console.log("Initializing App…");
      // … original sidebar / player setup …

      // Hide browser UI on scroll (mobile non-Safari)
      if (IS_MOBILE && !IS_SAFARI_MOBILE) {
        window.addEventListener('scroll', hideBrowserUI, { passive: true });
        document.documentElement.addEventListener('scroll', hideBrowserUI, { passive: true });
      }

      console.log("App Initialized.");
    }

    // Run initialization
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initializeApp);
    } else {
      initializeApp();
    }
  </script>
</body>
</html>