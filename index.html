<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Live DVR with Video.js Panzoom</title>
    <!-- Load Video.js CSS from CDN -->
    <link href="//vjs.zencdn.net/7.17.0/video-js.css" rel="stylesheet" />
    <style>
      /* GENERAL STYLES */
      html, body {
        margin: 0;
        padding: 0;
        height: 100vh;
        font-family: Arial, sans-serif;
        background: #222;
        color: #fff;
        overflow: hidden;
      }
      .container {
        display: flex;
        height: 100vh;
      }
      /* SIDEBAR */
      #sidebar {
        background: #444;
        width: 220px;
        padding: 20px;
        box-sizing: border-box;
        overflow-y: auto;
        transition: transform 0.3s ease;
      }
      #sidebar.hidden {
        transform: translateX(-100%);
      }
      #btn-add-urls {
        width: 100%;
        padding: 10px;
        margin-bottom: 10px;
        font-size: 16px;
        cursor: pointer;
      }
      #sideButtons {
        display: flex;
        gap: 10px;
        margin-bottom: 10px;
      }
      .sideBtn {
        flex: 1;
        padding: 10px;
        font-size: 16px;
        cursor: pointer;
      }
      #streamList {
        margin-top: 10px;
        line-height: 1.2;
      }
      #streamList label {
        color: #fff;
      }
      .no-streams {
        font-style: italic;
        color: #bbb;
        margin-top: 10px;
      }
      .stream-item {
        margin-bottom: 5px;
        display: flex;
        align-items: center;
      }
      .stream-item label {
        margin-left: 5px;
        font-size: 16px;
        cursor: pointer;
        user-select: none;
      }
      /* MAIN CONTENT – PLAYER CONTAINERS */
      #main-content {
        flex: 1;
        background: #333;
        padding: 20px;
        box-sizing: border-box;
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
        overflow: auto;
      }
      /* Desktop player container */
      .player-container.desktop {
        width: 960px;
        height: 600px;
        background: #222;
        display: flex;
        flex-direction: column;
        margin-bottom: 40px;
        box-sizing: border-box;
      }
      /* Mobile player container (approx. 4× smaller) */
      .player-container.mobile {
        width: 240px;
        height: 150px;
        background: #222;
        display: flex;
        flex-direction: column;
        margin-bottom: 20px;
        box-sizing: border-box;
      }
      /* Video.js styling */
      .player-container .video-js {
        width: 100%;
        height: 100%;
      }
      /* Title bar under each video */
      .title-bar {
        background: #333;
        text-align: center;
        padding: 5px;
        font-size: 16px;
      }
      /* URL Modal */
      #urlModal {
        display: none;
        position: fixed;
        z-index: 10;
        left: 50%;
        top: 50%;
        transform: translate(-50%, -50%);
        width: 1200px;
        background: #555;
        border: 2px solid #fff;
        padding: 15px;
        box-sizing: border-box;
      }
      #urlModal textarea {
        width: 100%;
        height: 600px;
        padding: 10px;
        font-size: 14px;
        box-sizing: border-box;
      }
      #urlModal button {
        width: 100%;
        padding: 10px;
        margin-top: 10px;
        font-size: 16px;
        cursor: pointer;
      }
      #modalBackdrop {
        display: none;
        position: fixed;
        z-index: 5;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
      }
      /* Mobile adjustments */
      html.mobile #urlModal {
        width: 300px;
        padding: 4px;
        font-size: 12px;
      }
      html.mobile #urlModal textarea {
        height: 150px;
        padding: 5px;
        font-size: 12px;
      }
      html.mobile #urlModal button {
        padding: 5px;
        font-size: 12px;
      }
      html.mobile #sidebar {
        position: fixed;
        top: 0;
        left: 0;
        height: 100%;
        z-index: 1000;
      }
      html.mobile #main-content {
        margin-left: 0;
      }
      /* Mobile sidebar toggle */
      #sidebarToggle {
        display: none;
      }
      html.mobile #sidebarToggle {
        display: block;
        position: fixed;
        top: 50%;
        left: 0;
        transform: translate(-50%, -50%);
        z-index: 1100;
        background: #444;
        border: none;
        padding: 10px 12px;
        font-size: 24px;
        color: #fff;
        cursor: pointer;
      }
    </style>
  </head>
  <body>
    <!-- Mobile sidebar toggle -->
    <button id="sidebarToggle">&#x25B6;</button>
    <!-- Global key listeners -->
    <script>
      let spaceHeld = false;
      window.addEventListener("keydown", function(e) {
        if(e.code === "Space" && !["input","textarea","button"].includes(document.activeElement.tagName.toLowerCase())) {
          e.preventDefault();
          spaceHeld = true;
        }
      });
      window.addEventListener("keyup", function(e) {
        if(e.code === "Space") spaceHeld = false;
      });
    </script>
    <div class="container">
      <div id="sidebar">
        <button id="btn-add-urls">Add URLs</button>
        <div id="sideButtons">
          <button id="btn-show-all" class="sideBtn">Show All</button>
          <button id="btn-hide-all" class="sideBtn">Hide All</button>
        </div>
        <div id="streamList"></div>
      </div>
      <div id="main-content"></div>
    </div>
    <div id="modalBackdrop"></div>
    <div id="urlModal">
      <h3 style="margin-top: 0; text-align: center;">Paste Playlist URLs (one per line)</h3>
      <textarea id="urlInput" placeholder="https://hls.cdn-surfline.com/oregon/wc-capitolapeak/playlist.m3u8"></textarea>
      <button id="saveUrls">Save and Close</button>
    </div>
    <!-- Load Video.js from CDN -->
    <script src="//vjs.zencdn.net/7.17.0/video.min.js"></script>
    <!-- Load videojs-panzoom plugin from jsDelivr (version 2.0.1) -->
    <script src="https://cdn.jsdelivr.net/npm/videojs-panzoom@2.0.1/dist/videojs-panzoom.min.js"></script>
    <script>
      // Register the panzoom plugin if available.
      if (typeof videojs.getPlugin('panzoom') !== 'function' && typeof panzoom === 'function') {
        videojs.registerPlugin('panzoom', panzoom);
      }
      
      /* Utility functions for panzoom state persistence */
      function loadPanzoomState(url) {
        const key = "panzoomState_" + url;
        try {
          return JSON.parse(localStorage.getItem(key) || "{}");
        } catch(e) { return {}; }
      }
      function savePanzoomState(url, state) {
        const key = "panzoomState_" + url;
        localStorage.setItem(key, JSON.stringify(state));
      }
      
      /* MAIN UI & STREAM MANAGEMENT */
      (function(){
        const storageKey = "streamConfigs";
        const activeLabels = new Set();
      
        function extractTitle(url) {
          const match = url.match(/wc-([^\/]+)\/playlist/);
          return match ? match[1] : url;
        }
        function saveStreamList(list) { localStorage.setItem(storageKey, JSON.stringify(list)); }
        function getStreamList() {
          try { return JSON.parse(localStorage.getItem(storageKey) || "[]"); }
          catch(e){ return []; }
        }
      
        function updateStreamSidebar() {
          const sidebarList = document.getElementById("streamList");
          sidebarList.innerHTML = "";
          const streams = getStreamList();
          if (streams.length === 0) {
            const p = document.createElement("p");
            p.className = "no-streams";
            p.textContent = "No streams added. Click 'Add URLs' to add streams.";
            sidebarList.appendChild(p);
          } else {
            streams.forEach(stream => {
              const videoSrc = stream.url;
              const title = extractTitle(videoSrc);
              const item = document.createElement("div");
              item.className = "stream-item";
              const checkbox = document.createElement("input");
              checkbox.type = "checkbox";
              checkbox.checked = stream.enabled;
              checkbox.setAttribute("data-url", videoSrc);
              checkbox.addEventListener("change", (e)=> { updateStreamEnabled(videoSrc, e.target.checked); });
              item.appendChild(checkbox);
              const label = document.createElement("label");
              label.textContent = title;
              label.setAttribute("data-url", videoSrc);
              label.addEventListener("mousedown", (e)=>{
                if(e.button===0){ 
                  checkbox.checked = !checkbox.checked;
                  activeLabels.add(label);
                  e.preventDefault();
                }
              });
              label.addEventListener("mouseenter", (e)=>{
                if(e.buttons & 1 && !activeLabels.has(label)){
                  checkbox.checked = !checkbox.checked;
                  activeLabels.add(label);
                }
              });
              item.appendChild(label);
              sidebarList.appendChild(item);
            });
          }
        }
      
        function toggleFullScreen(container) {
          if (!document.fullscreenElement) {
            container.requestFullscreen().catch(err => console.error("Full screen error:", err));
          } else {
            document.exitFullscreen().catch(err => console.error("Exit full screen error:", err));
          }
        }
      
        // Create a Video.js player container using videojs-panzoom.
        function createPlayerContainer(streamConfig) {
          if (!streamConfig.enabled) return null;
          const videoSrcOrig = streamConfig.url;
          // Wrap the original manifest URL with your proxy.
          const proxyPrefix = "https://surfcam-alpha.vercel.app/api/proxy?url=";
          const proxiedUrl = proxyPrefix + encodeURI(videoSrcOrig);
          const title = extractTitle(videoSrcOrig);
          const isMobile = document.documentElement.classList.contains("mobile");
          const container = document.createElement("div");
          container.className = "player-container " + (isMobile ? "mobile" : "desktop");
          container.setAttribute("data-url", videoSrcOrig);
      
          // Determine the base URL for resolving relative fragment URLs.
          var manifestBase = videoSrcOrig.substring(0, videoSrcOrig.lastIndexOf("/") + 1);
      
          // Create a unique video element.
          const videoId = "vid_" + Math.random().toString(36).substring(2,10);
          const videoEl = document.createElement("video");
          videoEl.id = videoId;
          videoEl.className = "video-js vjs-default-skin";
          videoEl.playsInline = true; // for iOS
          if (isMobile) {
            videoEl.style.width = "240px";
            videoEl.style.height = "135px";
          } else {
            videoEl.style.width = "960px";
            videoEl.style.height = "540px";
          }
          // Create the source element with the proxied manifest URL.
          const sourceEl = document.createElement("source");
          sourceEl.src = proxiedUrl;
          sourceEl.type = "application/x-mpegURL";
          videoEl.appendChild(sourceEl);
          container.appendChild(videoEl);
      
          // Video.js options: autoplay enabled (muted required).
          const vjsOptions = {
            controls: true,
            autoplay: true,
            muted: true,
            preload: "auto"
          };
          var vjsPlayer = videojs(videoEl, vjsOptions, function(){
            console.log("Video.js player ready for stream:", videoSrcOrig);
          });
      
          // Set up VHS beforeRequest hook to rewrite all requests.
          vjsPlayer.ready(function() {
            if (vjsPlayer.tech(true) && vjsPlayer.tech(true).vhs) {
              var vhsOptions = vjsPlayer.tech(true).vhs.options_ || {};
              vhsOptions.beforeRequest = function(options) {
                // Resolve relative URLs against the manifestBase.
                if (!/^https?:\/\//.test(options.uri)) {
                  options.uri = new URL(options.uri, manifestBase).toString();
                }
                // Use encodeURI to preserve slashes.
                if (!options.uri.startsWith(proxyPrefix)) {
                  options.uri = proxyPrefix + encodeURI(options.uri);
                }
                return options;
              };
              vjsPlayer.tech(true).vhs.options_ = vhsOptions;
            }
          });
      
          // On desktop, initialize the panzoom plugin.
          if (!isMobile) {
            vjsPlayer.ready(function() {
              var savedState = loadPanzoomState(videoSrcOrig);
              if (typeof vjsPlayer.panzoom === 'function') {
                vjsPlayer.panzoom(savedState);
                vjsPlayer.on("panzoomchange", function(){
                  var state = vjsPlayer.panzoom.getState();
                  savePanzoomState(videoSrcOrig, state);
                });
              } else {
                console.error("videojs-panzoom plugin is not available on this player.");
              }
            });
          }
      
          // Append a title bar below the player.
          var titleBar = document.createElement("div");
          titleBar.className = "title-bar";
          titleBar.textContent = title;
          container.appendChild(titleBar);
      
          container.vjsPlayer = vjsPlayer;
          return container;
        }
      
        function reorderPlayerContainers() {
          const mainContent = document.getElementById("main-content");
          const config = getStreamList();
          const players = Array.from(mainContent.querySelectorAll(".player-container"));
          players.sort((a, b) => {
            let indexA = config.findIndex(s => s.url === a.getAttribute("data-url"));
            let indexB = config.findIndex(s => s.url === b.getAttribute("data-url"));
            return indexA - indexB;
          });
          players.forEach(p => mainContent.appendChild(p));
        }
      
        function updateStreamEnabled(url, enabled) {
          let streams = getStreamList();
          const idx = streams.findIndex(s => s.url === url);
          if (idx === -1) return;
          if (streams[idx].enabled !== enabled) {
            streams[idx].enabled = enabled;
            saveStreamList(streams);
          }
          let playerContainer = document.querySelector('.player-container[data-url="'+url+'"]');
          const mainContent = document.getElementById("main-content");
          if (enabled) {
            if (!playerContainer) {
              playerContainer = createPlayerContainer(streams[idx]);
              if (playerContainer) mainContent.appendChild(playerContainer);
            } else {
              playerContainer.style.display = "flex";
            }
          } else {
            if (playerContainer) {
              if (playerContainer.vjsPlayer) {
                playerContainer.vjsPlayer.dispose();
              }
              if (playerContainer.parentNode) playerContainer.parentNode.removeChild(playerContainer);
            }
          }
          reorderPlayerContainers();
          const checkbox = document.querySelector('#streamList input[type="checkbox"][data-url="'+url+'"]');
          if (checkbox) checkbox.checked = enabled;
        }
      
        function updateFullUI(refresh = true) {
          if (refresh) {
            const mainContent = document.getElementById("main-content");
            mainContent.innerHTML = "";
            const streamList = getStreamList();
            const enabledStreams = streamList.filter(s => s.enabled);
            if (enabledStreams.length > 0) {
              enabledStreams.forEach(stream => {
                const player = createPlayerContainer(stream);
                if (player) mainContent.appendChild(player);
              });
              reorderPlayerContainers();
            }
            updateStreamSidebar();
          }
        }
      
        document.addEventListener("mouseup", function() {
          activeLabels.forEach(function(label) {
            const url = label.getAttribute("data-url");
            const checkbox = label.parentElement.querySelector("input[type='checkbox']");
            updateStreamEnabled(url, checkbox.checked);
          });
          activeLabels.clear();
        });
      
        function showAllStreams() {
          const streams = getStreamList();
          streams.forEach(stream => { updateStreamEnabled(stream.url, true); });
        }
        function hideAllStreams() {
          const streams = getStreamList();
          streams.forEach(stream => { updateStreamEnabled(stream.url, false); });
        }
        document.getElementById("btn-show-all").addEventListener("click", showAllStreams);
        document.getElementById("btn-hide-all").addEventListener("click", hideAllStreams);
      
        // URL Modal logic.
        const modal = document.getElementById("urlModal");
        const backdrop = document.getElementById("modalBackdrop");
        const btnAddUrls = document.getElementById("btn-add-urls");
        const btnSaveUrls = document.getElementById("saveUrls");
        const urlInput = document.getElementById("urlInput");
      
        function showModal() {
          const streams = getStreamList();
          urlInput.value = streams.map(s => s.url).join("\n");
          modal.style.display = "block";
          backdrop.style.display = "block";
        }
        function hideModal(saveChanges) {
          modal.style.display = "none";
          backdrop.style.display = "none";
          if (saveChanges) {
            const newUrls = urlInput.value.split("\n").map(u => u.trim()).filter(u => u);
            const oldStreams = getStreamList();
            const newConfig = [];
            newUrls.forEach(url => {
              const existing = oldStreams.find(s => s.url === url);
              if (existing) { newConfig.push(existing); }
              else { newConfig.push({ url: url, enabled: true }); }
            });
            saveStreamList(newConfig);
            updateStreamSidebar();
            oldStreams.forEach(s => { if (!newUrls.includes(s.url)) { updateStreamEnabled(s.url, false); } });
            newConfig.forEach(s => { if (s.enabled) { updateStreamEnabled(s.url, true); } });
          }
          urlInput.value = "";
        }
      
        btnAddUrls.addEventListener("click", showModal);
        btnSaveUrls.addEventListener("click", function() { hideModal(true); });
        window.addEventListener("keydown", function(e) {
          if (e.key === "Escape") { if (modal.style.display === "block") hideModal(false); }
        });
      
        updateFullUI();
      })();
      
      // Mobile: Sidebar swipe handling.
      (function(){
        if (!document.documentElement.classList.contains("mobile")) return;
        const sidebar = document.getElementById("sidebar");
        const toggleBtn = document.getElementById("sidebarToggle");
        let touchStartX = 0, touchEndX = 0;
        const swipeThreshold = 50;
        sidebar.addEventListener("touchstart", function(e) { touchStartX = e.changedTouches[0].screenX; });
        sidebar.addEventListener("touchend", function(e) {
          touchEndX = e.changedTouches[0].screenX;
          if (touchStartX - touchEndX > swipeThreshold) { sidebar.classList.add("hidden"); toggleBtn.style.display = "block"; }
        });
        toggleBtn.addEventListener("click", function() { sidebar.classList.remove("hidden"); toggleBtn.style.display = "none"; });
      })();
      
      // Desktop: Listen for fullscreen change events.
      document.addEventListener("fullscreenchange", function() {
        console.log("Fullscreen changed. Now", document.fullscreenElement ? "Full screen" : "Windowed");
      });
    </script>
  </body>
</html>