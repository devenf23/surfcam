<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Live DVR w/ Hls.js + Panzoom</title>
  <style>
    html,body{margin:0;padding:0;height:100vh;overflow:hidden;background:#222;color:#fff;font-family:sans-serif}
    .container{display:flex;height:100vh}
    #sidebar{width:220px;background:#444;padding:20px;box-sizing:border-box;overflow-y:auto;transition:transform .3s}
    #sidebar.hidden{transform:translateX(-100%)}
    button, input[type=range]{cursor:pointer}
    #btn-add-urls{width:100%;padding:8px;margin-bottom:8px}
    .sideBtn{flex:1;padding:8px;font-size:14px}
    #sideButtons{display:flex;gap:8px;margin-bottom:8px}
    #streamList .stream-item{display:flex;align-items:center;margin-bottom:4px}
    #streamList label{margin-left:4px;user-select:none}
    #main-content{flex:1;background:#333;padding:20px;box-sizing:border-box;display:flex;flex-wrap:wrap;gap:20px;overflow:auto}
    .player-container{background:#222;display:flex;flex-direction:column;position:relative;box-sizing:border-box}
    .player-container.desktop{width:960px;height:600px}
    .player-container.mobile{width:240px;height:150px}
    canvas{background:black;touch-action:none}
    .controls{display:flex;align-items:center;background:rgba(0,0,0,.6);padding:4px;gap:8px}
    .controls button{padding:4px 8px;font-size:14px}
    .controls input[type=range]{flex:1}
    .title-bar{background:#111;color:#fff;text-align:center;padding:4px;font-size:14px}
    #urlModal{display:none;position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);width:800px;max-width:90%;background:#555;border:2px solid #fff;padding:16px;box-sizing:border-box;z-index:10}
    #urlModal textarea{width:100%;height:200px;box-sizing:border-box;font-size:14px;padding:8px}
    #modalBackdrop{display:none;position:fixed;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,.5);z-index:5}
  </style>
</head>
<body>

<div class="container">
  <div id="sidebar">
    <button id="btn-add-urls">Add URLs</button>
    <div id="sideButtons">
      <button id="btn-show-all" class="sideBtn">Show All</button>
      <button id="btn-hide-all" class="sideBtn">Hide All</button>
    </div>
    <div id="streamList"></div>
  </div>
  <div id="main-content"></div>
</div>

<div id="modalBackdrop"></div>
<div id="urlModal">
  <h3>Add HLS URLs (one per line)</h3>
  <textarea id="urlInput"></textarea>
  <button id="saveUrls">Save & Close</button>
</div>

<!-- Hls.js -->
<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
<!-- Panzoom -->
<script src="https://unpkg.com/@panzoom/panzoom@9.4.0/dist/panzoom.min.js"></script>
<script>
  // ProxyLoader as you had it
  class ProxyLoader {
    constructor(config) {
      this.customPlaylistBase = config.customPlaylistBase||"";
      this.loader = new Hls.DefaultConfig.loader(config);
    }
    load(context, config, callbacks) {
      const proxy = "https://surfcam-alpha.vercel.app/api/proxy?url=";
      let raw = context.url;
      try {
        if(raw.startsWith(proxy)) {
          const u=new URL(raw); raw=u.searchParams.get("url")||raw;
        }
      }catch(e){}
      // fragments or playlists
      if(!raw.startsWith("https://")) {
        // relative or local
        const seg=raw.substring(raw.lastIndexOf("/")+1);
        raw=this.customPlaylistBase+seg;
      }
      context.url=proxy+encodeURIComponent(raw);
      this.loader.load(context,config,callbacks);
    }
    abort(){this.loader.abort&&this.loader.abort()}
    destroy(){this.loader.destroy&&this.loader.destroy()}
  }

  // Sidebar & streams
  const storageKey="streamConfigs";
  function getList(){try{return JSON.parse(localStorage.getItem(storageKey)||"[]")}catch(e){return[]}}
  function saveList(l){localStorage.setItem(storageKey,JSON.stringify(l))}
  const activeLabels=new Set();

  function extractTitle(u){
    const m=u.match(/wc-([^/]+)\//);
    return m?m[1]:u;
  }

  function updateSidebar(){
    const parent=document.getElementById("streamList");
    parent.innerHTML="";
    const list=getList();
    if(!list.length){
      const p=document.createElement("p");p.className="no-streams";p.textContent="No streams";parent.appendChild(p);
      return;
    }
    list.forEach(s=>{
      const row=document.createElement("div");row.className="stream-item";
      const cb=document.createElement("input");cb.type="checkbox";cb.checked=s.enabled;cb.dataset.url=s.url;
      cb.onchange=e=>toggleStream(s.url,e.target.checked);
      row.appendChild(cb);
      const lbl=document.createElement("label");lbl.textContent=extractTitle(s.url);lbl.dataset.url=s.url;
      lbl.onmousedown=e=>{
        if(e.button===0){cb.checked=!cb.checked;activeLabels.add(lbl);e.preventDefault()}
      };
      lbl.onmouseenter=e=>{
        if(e.buttons&1&&!activeLabels.has(lbl)){cb.checked=!cb.checked;activeLabels.add(lbl)}
      };
      row.appendChild(lbl);
      parent.appendChild(row);
    });
  }

  function toggleStream(url,on){
    let cfg=getList();
    const idx=cfg.findIndex(x=>x.url===url);
    if(idx>=0)cfg[idx].enabled=on; else return;
    saveList(cfg);
    renderStreams();
    updateSidebar();
  }

  document.addEventListener("mouseup",()=>{
    activeLabels.forEach(lbl=>{
      const url=lbl.dataset.url;
      const cb=document.querySelector(`input[data-url="${url}"]`);
      toggleStream(url,cb.checked);
    });
    activeLabels.clear();
  });

  document.getElementById("btn-show-all").onclick=()=>getList().forEach(s=>toggleStream(s.url,true));
  document.getElementById("btn-hide-all").onclick=()=>getList().forEach(s=>toggleStream(s.url,false));

  // Modal
  const modal=document.getElementById("urlModal"),back=document.getElementById("modalBackdrop");
  document.getElementById("btn-add-urls").onclick=()=>{
    document.getElementById("urlInput").value=getList().map(x=>x.url).join("\n");
    modal.style.display="block";back.style.display="block";
  };
  document.getElementById("saveUrls").onclick=()=>{
    const lines=document.getElementById("urlInput").value.split("\n").map(x=>x.trim()).filter(x=>x);
    const old=getList(),newCfg=[];
    lines.forEach(u=>{
      const ex=old.find(x=>x.url===u);
      newCfg.push(ex||{url:u,enabled:true});
    });
    saveList(newCfg);
    modal.style.display="none";back.style.display="none";
    renderStreams();updateSidebar();
  };
  window.addEventListener("keydown",e=>{if(e.key==="Escape"&&modal.style.display==="block"){modal.style.display="none";back.style.display="none"}});

  // Render streams
  function renderStreams(){
    const main=document.getElementById("main-content");main.innerHTML="";
    getList().filter(s=>s.enabled).forEach(s=>{
      const url=s.url;
      const isMobile=document.documentElement.classList.contains("mobile");
      const cont=document.createElement("div");
      cont.className="player-container "+(isMobile?"mobile":"desktop");
      cont.dataset.url=url;
      // create video element
      const v=document.createElement("video");
      v.crossOrigin="anonymous";
      v.muted=true; // for autoplay
      v.autoplay=true;
      v.playsInline=true;
      v.controls=!isMobile; // mobile show native controls
      cont.appendChild(v);
      // timeline & play/pause
      const controls=document.createElement("div");controls.className="controls";
      const btn=document.createElement("button");btn.textContent="Pause";
      const range=document.createElement("input");range.type="range";range.min=0;range.step=0.1;
      controls.appendChild(btn);controls.appendChild(range);
      cont.appendChild(controls);
      // title
      const tbar=document.createElement("div");tbar.className="title-bar";tbar.textContent=extractTitle(url);
      cont.appendChild(tbar);
      main.appendChild(cont);

      // setup Hls.js
      if(Hls.isSupported()){
        const hls=new Hls({
          loader:ProxyLoader,
          customPlaylistBase:url.substring(0,url.lastIndexOf("/")+1)
        });
        hls.loadSource(url);
        hls.attachMedia(v);
        hls.on(Hls.Events.MANIFEST_PARSED,()=>{
          v.play().catch(()=>{/*ignore*/});
        });
        // timeupdate
        v.ontimeupdate=()=>{
          range.max=v.duration||0;
          range.value=v.currentTime;
        };
        btn.onclick=()=>{
          if(v.paused){v.play();btn.textContent="Pause"}else{v.pause();btn.textContent="Play"}
        };
        range.oninput=()=>v.currentTime=range.value;
      }
      // panzoom on container for desktop
      if(!isMobile){
        const panzoomInstance=Panzoom(cont.querySelector("video"),{
          contain:"outside",
          maxScale:3,
          step:0.1
        });
        // save and restore state
        const key="pz_"+url;
        const saved=localStorage.getItem(key);
        if(saved)panzoomInstance.zoomAbs(0,0,JSON.parse(saved).scale);
        panzoomInstance.on("transform",()=>{
          const s=panzoomInstance.getScale();
          localStorage.setItem(key,JSON.stringify({scale:s}));
        });
      }
    });
  }

  // init
  updateSidebar();
  renderStreams();
</script>
</body>
</html>