<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Live DVR – Desktop & Mobile (with CORS‑/Range‑Aware Proxy & Robust Fullscreen)</title>
  <style>
    /* … your existing CSS … */
    html, body { margin:0; padding:0; height:100vh; background:#222; color:#fff; overflow:hidden; font-family:Arial,sans-serif; }
    .container { display:flex; height:100vh; }
    #sidebar { background:#444; width:220px; padding:20px; box-sizing:border-box; overflow-y:auto; transition:transform .3s; }
    #sidebar.hidden { transform:translateX(-100%); }
    #sidebarToggle { display:none; }
    html.mobile #sidebarToggle { display:block; position:fixed; top:50%; left:0; transform:translate(-50%,-50%); z-index:1100; background:#444; border:none; padding:10px; font-size:24px; color:#fff; cursor:pointer; }
    #main-content { flex:1; background:#333; padding:20px; box-sizing:border-box; display:flex; flex-wrap:wrap; gap:20px; overflow:auto; }
    .player-container.desktop, .player-container.mobile { background:#222; display:flex; flex-direction:column; position:relative; box-sizing:border-box; }
    .player-container.desktop { width:960px; height:600px; margin-bottom:40px; }
    .player-container.mobile  { width:240px; height:150px; margin-bottom:20px; }
    .player-container.desktop .source-video { opacity:0; position:absolute; top:0; left:0; width:960px; height:540px; pointer-events:none; }
    .player-container.desktop .display-canvas { background:black; width:960px; height:540px; }
    .player-container.mobile  .source-video { width:240px; height:135px; }
    .player-container.mobile  .display-canvas { display:none; }
    .controls-container { position:relative; z-index:2; transition:opacity .5s; }
    .control-bar { height:60px; display:flex; align-items:center; background:rgba(0,0,0,.75); padding:5px 10px; gap:10px; }
    .control-bar button { padding:4px 8px; font-size:14px; cursor:pointer; }
    .control-bar input[type=range] { flex:1; }
    .title-bar { text-align:center; padding:2px 10px; background:rgba(0,0,0,.75); font-size:16px; }
    .disable-btn { background:red; color:#fff; border:none; }
    .mobile-play-overlay { position:absolute; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,.6); display:flex; align-items:center; justify-content:center; color:#fff; font-size:24px; z-index:10; }
    #urlModal { display:none; position:fixed; z-index:10; left:50%; top:50%; transform:translate(-50%,-50%); width:1200px; background:#555; border:2px solid #fff; padding:15px; box-sizing:border-box; }
    #urlModal textarea { width:100%; height:600px; padding:10px; font-size:14px; box-sizing:border-box; }
    #urlModal button { width:100%; padding:10px; margin-top:10px; font-size:16px; cursor:pointer; }
    #modalBackdrop { display:none; position:fixed; z-index:5; left:0; top:0; width:100%; height:100%; background:rgba(0,0,0,.5); }
    html.mobile #urlModal { width:300px; padding:4px; font-size:12px; }
    html.mobile #urlModal textarea { height:150px; padding:5px; font-size:12px; }
    html.mobile #urlModal button { padding:5px; font-size:12px; }
    html.mobile #sidebar { position:fixed; top:0; left:0; height:100%; z-index:1000; }
    html.mobile #main-content { margin-left:0; }
  </style>
  <script>
    // Mark mobile UA
    if (/Mobi|Android|iPhone|iPad/i.test(navigator.userAgent)) {
      document.documentElement.classList.add("mobile");
    }
  </script>
  <!-- Fullscreen utility -->
  <script>
    function enterFullScreen(el) {
      const req = el.requestFullscreen
                || el.webkitRequestFullscreen
                || el.mozRequestFullScreen
                || el.msRequestFullscreen;
      if (req) return req.call(el);
      console.warn("Fullscreen API not supported on this element");
    }
    function exitFullScreen() {
      const ex = document.exitFullscreen
               || document.webkitExitFullscreen
               || document.mozCancelFullScreen
               || document.msExitFullscreen;
      if (ex) return ex.call(document);
    }
  </script>
</head>
<body>
  <button id="sidebarToggle">&#x25B6;</button>
  <div class="container">
    <div id="sidebar">
      <button id="btn-add-urls">Add URLs</button>
      <div id="sideButtons">
        <button id="btn-show-all" class="sideBtn">Show All</button>
        <button id="btn-hide-all" class="sideBtn">Hide All</button>
      </div>
      <div id="streamList"></div>
    </div>
    <div id="main-content"></div>
  </div>
  <div id="modalBackdrop"></div>
  <div id="urlModal">
    <h3 style="text-align:center;margin-top:0;">Paste Playlist URLs (one per line)</h3>
    <textarea id="urlInput" placeholder="https://…/playlist.m3u8"></textarea>
    <button id="saveUrls">Save and Close</button>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/hls.js@0.14.16"></script>
  <script>
    // Node-style proxy loader unchanged, points at /api/proxy...
    class ProxyLoader {
      constructor(config) {
        this.customPlaylistBase = config.customPlaylistBase || "";
        this.loader = new Hls.DefaultConfig.loader(config);
      }
      load(ctx, cfg, cb) {
        const proxy = "https://YOUR-VERCEL-APP.vercel.app/api/proxy?url=";
        let url = ctx.url;
        // unwrap any existing proxy
        if (url.startsWith(proxy)) {
          try {
            url = new URL(url).searchParams.get("url") || url;
          } catch(e){}
        }
        // apply customPlaylistBase logic …
        ctx.url = proxy + encodeURIComponent(url);
        this.loader.load(ctx,cfg,cb);
      }
      abort() { this.loader.abort && this.loader.abort(); }
      destroy() { this.loader.destroy && this.loader.destroy(); }
    }

    // … utility functions load/save settings …

    (function(){
      // … all your sidebar, URL‑modal, storage, etc. code unchanged …

      function createPlayerContainer(streamConfig) {
        if (!streamConfig.enabled) return null;
        const url = streamConfig.url;
        const isMobile = document.documentElement.classList.contains("mobile");
        const container = document.createElement("div");
        container.className = "player-container " + (isMobile?"mobile":"desktop");
        container.setAttribute("data-url",url);
        container.zoomScale = loadPlayerSettings(url).zoomScale;
        container.panX = loadPlayerSettings(url).panX;
        container.panY = loadPlayerSettings(url).panY;

        // video element
        const v = document.createElement("video");
        v.className = "source-video";
        v.crossOrigin = "anonymous";
        v.playsInline = true;
        v.setAttribute("playsinline","true");
        v.setAttribute("webkit-playsinline","true");
        v.muted = true;
        v.preload = "auto";
        v.setAttribute("crossorigin","anonymous");
        if (isMobile) v.controls = true;
        else v.autoplay = true;
        container.appendChild(v);

        // canvas for desktop
        let canvas, ctx;
        if (!isMobile) {
          canvas = document.createElement("canvas");
          canvas.className = "display-canvas";
          canvas.width = 960; canvas.height = 540;
          container.appendChild(canvas);
          ctx = canvas.getContext("2d");
          (function render(){
            if (v.readyState>=2) {
              if (document.fullscreenElement) {
                canvas.width = container.clientWidth;
                canvas.height = container.clientHeight;
              } else {
                canvas.width = 960; canvas.height = 540;
              }
              ctx.save();
              const cx = canvas.width/2, cy = canvas.height/2;
              ctx.clearRect(0,0,canvas.width,canvas.height);
              ctx.translate(cx,cy);
              ctx.scale(container.zoomScale,container.zoomScale);
              ctx.translate(container.panX,container.panY);
              ctx.translate(-cx,-cy);
              ctx.drawImage(v,0,0,canvas.width,canvas.height);
              ctx.restore();
            }
            requestAnimationFrame(render);
          })();
        } else {
          // "Tap to Start" overlay
          const overlay = document.createElement("div");
          overlay.className = "mobile-play-overlay";
          overlay.innerText = "Tap to Start";
          container.appendChild(overlay);
          v.addEventListener("play", () => overlay.style.display="none");
          v.addEventListener("pause", () => overlay.style.display="flex");
          overlay.addEventListener("click", ()=> v.play().catch(console.error));
        }

        // controls (desktop only)
        let timeline;
        if (!isMobile) {
          const cc = document.createElement("div");
          cc.className = "controls-container overlay-controls";
          container.appendChild(cc);
          const bar = document.createElement("div");
          bar.className = "control-bar";
          const btn = document.createElement("button");
          btn.textContent = "Play";
          v.addEventListener("play", ()=> btn.textContent="Pause");
          v.addEventListener("pause",()=> btn.textContent="Play");
          btn.addEventListener("click",()=> v.paused ? v.play().catch(console.error):v.pause());
          bar.appendChild(btn);
          timeline = document.createElement("input");
          timeline.type="range"; timeline.min=0; timeline.step=0.1; timeline.value=0;
          timeline.addEventListener("input", ()=> v.currentTime=timeline.value);
          v.addEventListener("timeupdate",()=> timeline.value=v.currentTime);
          bar.appendChild(timeline);
          const fsBtn = document.createElement("button");
          fsBtn.textContent="⛶ Fullscreen";
          fsBtn.addEventListener("click",()=>{
            if (!document.fullscreenElement) enterFullScreen(container);
            else exitFullScreen();
          });
          bar.appendChild(fsBtn);
          const reset = document.createElement("button");
          reset.textContent="Reset";
          reset.addEventListener("click",()=>{
            container.zoomScale=1;container.panX=0;container.panY=0;
            savePlayerSettings(url,{zoomScale:1,panX:0,panY:0});
          });
          bar.appendChild(reset);
          const dis = document.createElement("button");
          dis.className="disable-btn"; dis.textContent="X";
          dis.addEventListener("click",e=>{ e.stopPropagation(); updateStreamEnabled(url,false); });
          bar.appendChild(dis);
          cc.appendChild(bar);
          const titleBar = document.createElement("div");
          titleBar.className="title-bar";
          titleBar.textContent=extractTitle(url);
          cc.appendChild(titleBar);
        }

        // Hls.js init
        if (Hls.isSupported() && !isMobile) {
          const hls = new Hls({
            loader: ProxyLoader,
            customPlaylistBase: url.substring(0,url.lastIndexOf("/")+1)
          });
          hls.attachMedia(v);
          hls.on(Hls.Events.MANIFEST_PARSED,()=>{
            v.play().catch(console.error);
          });
          hls.loadSource(url);
          container.hls = hls;
        } else if (v.canPlayType("application/vnd.apple.mpegurl")) {
          v.src = url;
          v.addEventListener("loadedmetadata",()=> v.play().catch(console.error));
        }

        return container;
      }

      // … the rest of your UI init, sidebar toggles, updateStreamEnabled, etc. …

      // Sidebar swipe for mobile
      (function(){
        if (!document.documentElement.classList.contains("mobile")) return;
        const sb = document.getElementById("sidebar");
        const tb = document.getElementById("sidebarToggle");
        let startX=0;
        sb.addEventListener("touchstart",e=> startX=e.changedTouches[0].screenX);
        sb.addEventListener("touchend",e=>{
          if (startX - e.changedTouches[0].screenX > 50) {
            sb.classList.add("hidden");
            tb.style.display="block";
          }
        });
        tb.addEventListener("click",()=>{
          sb.classList.remove("hidden");
          tb.style.display="none";
        });
      })();

      // Fullscreen change logger (optional)
      document.addEventListener("fullscreenchange",()=> {
        console.log("Fullscreen now", !!document.fullscreenElement);
      });

      // Finally, build UI
      updateFullUI();
    })();
  </script>
</body>
</html>