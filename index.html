<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Live DVR – Desktop & Mobile</title>
  <style>
    /* —————————————————————————————————————————————————————————
       (All of your previous CSS here, unchanged, including
       the fullscreen‐canvas stretch rule you already added)
    ————————————————————————————————————————————————————————— */
  </style>
  <script>
    // Add "mobile" class if the user agent indicates a mobile device.
    if (/Mobi|Android|iPhone|iPad/i.test(navigator.userAgent)) {
      document.documentElement.classList.add("mobile");
    }
    // Spacebar‐held for pan/zoom
    let spaceHeld = false;
    window.addEventListener("keydown", e => {
      if (e.code === "Space"
       && !["input","textarea","button"].includes(document.activeElement.tagName.toLowerCase())) {
        e.preventDefault();
        spaceHeld = true;
      }
    });
    window.addEventListener("keyup", e => { if (e.code === "Space") spaceHeld = false; });
  </script>
</head>
<body>
  <!-- Your sidebar, main‐content, modal markup goes here exactly as before -->
  <div class="container">…</div>
  <div id="modalBackdrop"></div>
  <div id="urlModal">…</div>

  <script src="https://cdn.jsdelivr.net/npm/hls.js@0.14.16"></script>
  <script>
    // —————————————————————————————————————————————————————————
    // Fullscreen helpers (all prefixes)
    function enterFullScreen(el) {
      const req = el.requestFullscreen
               || el.webkitRequestFullscreen
               || el.mozRequestFullScreen
               || el.msRequestFullscreen;
      if (req) req.call(el);
    }
    function exitFullScreen() {
      const exit = document.exitFullscreen
                 || document.webkitExitFullscreen
                 || document.mozCancelFullScreen
                 || document.msExitFullscreen;
      if (exit) exit.call(document);
    }

    // Your proxy prefix (change to your deployment)
    const PROXY_PREFIX = "https://surfcam-alpha.vercel.app/api/proxy?url=";

    // Persist zoom/pan
    function loadPlayerSettings(url) {
      try { return JSON.parse(localStorage.playerSettings||"{}")[url] || {zoomScale:1,panX:0,panY:0}; }
      catch { return {zoomScale:1,panX:0,panY:0}; }
    }
    function savePlayerSettings(url,data) {
      let obj = {};
      try { obj = JSON.parse(localStorage.playerSettings||"{}"); } catch{}
      obj[url] = data;
      localStorage.playerSettings = JSON.stringify(obj);
    }

    (function(){
      // … all of your stream‐list, sidebar, modal, utility code exactly as before …

      function createPlayerContainer(streamConfig) {
        const videoSrc = streamConfig.url;
        const isMobile = document.documentElement.classList.contains("mobile");
        const saved   = loadPlayerSettings(videoSrc);

        // Container
        const container = document.createElement("div");
        container.className = "player-container " + (isMobile?"mobile":"desktop");
        container.dataset.url = videoSrc;
        container.zoomScale = saved.zoomScale;
        container.panX = saved.panX;
        container.panY = saved.panY;

        // Video element
        const sourceVideo = document.createElement("video");
        sourceVideo.className = "source-video";
        sourceVideo.setAttribute("playsinline","true");
        sourceVideo.setAttribute("webkit-playsinline","true");
        sourceVideo.setAttribute("crossorigin","anonymous");
        sourceVideo.muted = true;
        sourceVideo.preload = "auto";

        if (isMobile) {
          // Native mobile playback via proxy
          sourceVideo.controls = true;
          sourceVideo.src = PROXY_PREFIX + encodeURIComponent(videoSrc);
        } else {
          // Desktop auto‐play (under Hls.js)
          sourceVideo.autoplay = true;
        }

        container.appendChild(sourceVideo);

        // Mobile “tap to start” overlay
        if (isMobile) {
          const overlay = document.createElement("div");
          overlay.className = "mobile-play-overlay";
          overlay.textContent = "Tap to Start";
          container.appendChild(overlay);

          overlay.addEventListener("click", () => {
            // If Hls.js is managing this, kick off the load
            if (container.hls) container.hls.startLoad();
            sourceVideo.play().then(() => { overlay.style.display = "none"; })
                              .catch(console.error);
          });
          sourceVideo.addEventListener("play",  () => overlay.style.display = "none");
          sourceVideo.addEventListener("pause", () => overlay.style.display = "flex");

        } else {
          // Desktop: Canvas + render loop
          const canvas = document.createElement("canvas");
          canvas.className = "display-canvas";
          canvas.width  = 960;
          canvas.height = 540;
          container.appendChild(canvas);
          const ctx = canvas.getContext("2d");
          (function render(){
            if (sourceVideo.readyState >= 2) {
              if (document.fullscreenElement === container) {
                canvas.width  = container.clientWidth;
                canvas.height = container.clientHeight;
              } else {
                canvas.width  = 960;
                canvas.height = 540;
              }
              ctx.save();
              ctx.clearRect(0,0,canvas.width,canvas.height);
              const cx = canvas.width/2, cy = canvas.height/2;
              ctx.translate(cx,cy);
              ctx.scale(container.zoomScale, container.zoomScale);
              ctx.translate(container.panX, container.panY);
              ctx.translate(-cx,-cy);
              try { ctx.drawImage(sourceVideo,0,0,canvas.width,canvas.height); }
              catch(e) {}
              ctx.restore();
            }
            requestAnimationFrame(render);
          })();

          // Desktop pan/zoom
          let startX=0, startY=0, dragging=false;
          canvas.addEventListener("mousedown", e => {
            if (e.button !== 0 || (!spaceHeld && document.fullscreenElement!==container)) return;
            startX = e.clientX; startY = e.clientY; dragging = false;
          });
          canvas.addEventListener("mousemove", e => {
            if (!(e.buttons & 1) || (!spaceHeld && document.fullscreenElement!==container)) return;
            const dx = e.clientX - startX, dy = e.clientY - startY;
            if (!dragging && Math.hypot(dx,dy)>5) dragging = true;
            if (dragging) {
              container.panX += dx/container.zoomScale;
              container.panY += dy/container.zoomScale;
              const halfW=960/2, halfH=540/2, z=container.zoomScale;
              container.panX = Math.min(halfW*z-halfW, Math.max(halfW-halfW*z, container.panX));
              container.panY = Math.min(halfH*z-halfH, Math.max(halfH-halfH*z, container.panY));
              savePlayerSettings(videoSrc,{zoomScale:z,panX:container.panX,panY:container.panY});
              startX = e.clientX; startY = e.clientY;
            }
          });
          canvas.addEventListener("wheel", e => {
            if (!spaceHeld && document.fullscreenElement!==container) return;
            e.preventDefault();
            const rect = canvas.getBoundingClientRect();
            const logicalX = (e.clientX - rect.left)/rect.width * canvas.width;
            const logicalY = (e.clientY - rect.top )/rect.height* canvas.height;
            const oldZ = container.zoomScale;
            let newZ = oldZ + (e.deltaY<0?0.1:-0.1);
            newZ = Math.max(1, Math.min(3, newZ));
            container.panX += (oldZ-newZ)*((logicalX - canvas.width/2)/newZ);
            container.panY += (oldZ-newZ)*((logicalY - canvas.height/2)/newZ);
            container.zoomScale = newZ;
            const halfW = 960/2, halfH = 540/2;
            container.panX = Math.min(halfW*newZ-halfW, Math.max(halfW-halfW*newZ, container.panX));
            container.panY = Math.min(halfH*newZ-halfH, Math.max(halfH-halfH*newZ, container.panY));
            savePlayerSettings(videoSrc,{zoomScale:newZ,panX:container.panX,panY:container.panY});
          }, {passive:false});
          canvas.addEventListener("click", () => {
            if (sourceVideo.paused) sourceVideo.play().catch(console.error);
            else sourceVideo.pause();
          });
        }

        // Desktop custom controls + timeline
        let timeline = null;
        if (!isMobile) {
          const cc = document.createElement("div");
          cc.className = "controls-container overlay-controls";
          container.appendChild(cc);

          const bar = document.createElement("div");
          bar.className = "control-bar";

          // Play/Pause
          const playBtn = document.createElement("button");
          playBtn.textContent = "Play";
          playBtn.addEventListener("click", () => {
            if (sourceVideo.paused) sourceVideo.play().catch(console.error);
            else sourceVideo.pause();
          });
          sourceVideo.addEventListener("play",  () => playBtn.textContent = "Pause");
          sourceVideo.addEventListener("pause", () => playBtn.textContent = "Play");
          bar.appendChild(playBtn);

          // Timeline
          timeline = document.createElement("input");
          timeline.type = "range";
          timeline.min  = 0;
          timeline.step = 0.1;
          timeline.value= 0;
          let isSeeking = false;
          timeline.addEventListener("input", () => sourceVideo.currentTime = timeline.value);
          timeline.addEventListener("mousedown", () => isSeeking = true);
          timeline.addEventListener("mouseup",   () => isSeeking = false);
          sourceVideo.addEventListener("loadedmetadata", () => timeline.max = sourceVideo.duration||0);
          sourceVideo.addEventListener("timeupdate", () => {
            if (!isSeeking) timeline.value = sourceVideo.currentTime;
          });
          bar.appendChild(timeline);

          // Fullscreen button
          const fsBtn = document.createElement("button");
          fsBtn.textContent = "⛶";
          fsBtn.addEventListener("click", () => {
            if (!document.fullscreenElement) enterFullScreen(container);
            else exitFullScreen();
          });
          bar.appendChild(fsBtn);

          // Reset zoom/pan
          const resetBtn = document.createElement("button");
          resetBtn.textContent = "Reset";
          resetBtn.addEventListener("click", () => {
            container.zoomScale = 1; container.panX = 0; container.panY = 0;
            savePlayerSettings(videoSrc,{zoomScale:1,panX:0,panY:0});
          });
          bar.appendChild(resetBtn);

          // Disable stream
          const disableBtn = document.createElement("button");
          disableBtn.className = "disable-btn";
          disableBtn.textContent = "X";
          disableBtn.addEventListener("click", e => {
            e.stopPropagation();
            updateStreamEnabled(videoSrc,false);
          });
          bar.appendChild(disableBtn);

          cc.appendChild(bar);

          // Title bar
          const titleBar = document.createElement("div");
          titleBar.className = "title-bar";
          titleBar.textContent = extractTitle(videoSrc);
          cc.appendChild(titleBar);

          // Fade‑out controls **only** when in full‑screen
          let hideTO;
          function scheduleHide() {
            hideTO = setTimeout(() => cc.style.opacity = 0, 3000);
          }
          document.addEventListener("mousemove", e => {
            if (document.fullscreenElement === container) {
              cc.style.opacity = 1;
              clearTimeout(hideTO);
              if (e.clientY > window.innerHeight - 100) scheduleHide();
            }
          });
          document.addEventListener("fullscreenchange", () => {
            if (document.fullscreenElement === container) {
              cc.style.opacity = 1;
              scheduleHide();
            } else {
              cc.style.opacity = 1;
              clearTimeout(hideTO);
            }
          });
        }

        // Hls.js setup (desktop & mobile MSE)
        if (Hls.isSupported()) {
          const hls = new Hls({
            maxBufferLength: 120,
            maxBufferSize: 60*1000*1024,
            liveSyncDurationCount: 3,
            manifestLoadingTimeOut: 30000,
            levelLoadingTimeOut: 30000,
            loader: class extends Hls.DefaultConfig.loader {
              load(ctx, cfg, cb) {
                let url = ctx.url;
                while (url.startsWith(PROXY_PREFIX)) {
                  url = decodeURIComponent(url.slice(PROXY_PREFIX.length));
                }
                ctx.url = PROXY_PREFIX + encodeURIComponent(url);
                super.load(ctx, cfg, cb);
              }
            }
          });
          hls.attachMedia(sourceVideo);
          hls.on(Hls.Events.MANIFEST_PARSED, () => {
            // timeline max fix
            if (!isMobile && timeline) {
              timeline.max = sourceVideo.duration || 0;
            }
            if (!isMobile) sourceVideo.play().catch(console.error);
          });
          hls.loadSource(videoSrc);
          hls.on(Hls.Events.ERROR, (_, data) => {
            if (data.fatal) {
              switch (data.type) {
                case Hls.ErrorTypes.NETWORK_ERROR: hls.startLoad(); break;
                case Hls.ErrorTypes.MEDIA_ERROR:   hls.recoverMediaError(); break;
                default:                            hls.destroy(); break;
              }
            }
          });
          container.hls = hls;

        } else if (sourceVideo.canPlayType("application/vnd.apple.mpegurl")) {
          // Native fallback (iOS Safari)
          sourceVideo.src = PROXY_PREFIX + encodeURIComponent(videoSrc);
          if (!isMobile) sourceVideo.play().catch(console.error);
        }

        // dblclick → fullscreen on the container
        container.addEventListener("dblclick", () => {
          if (!document.fullscreenElement) enterFullScreen(container);
          else exitFullScreen();
        });

        return container;
      }

      // … remainder of your IIFE (initial UI build, sidebar buttons, URL modal, etc.) …

    })();
  </script>
</body>
</html>